{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>{{ title }}</h1>
        {% if movement %}
        <a href="{% url 'warehouse:sales_movement_detail' movement.id %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Отмена
        </a>
        {% else %}
        <a href="{% url 'warehouse:sales_department_dashboard' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Назад
        </a>
        {% endif %}
    </div>

    {% if messages %}
    <div class="messages mb-4">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {% if form.errors %}
    <div class="alert alert-danger mb-4">
        <h5 class="alert-heading"><i class="bi bi-exclamation-triangle-fill"></i> Ошибка при заполнении формы</h5>
        <ul class="mb-0">
            {% for field, errors in form.errors.items %}
                {% for error in errors %}
                    <li>{{ error }}</li>
                {% endfor %}
            {% endfor %}
            {% if form.non_field_errors %}
                {% for error in form.non_field_errors %}
                    <li>{{ error }}</li>
                {% endfor %}
            {% endif %}
        </ul>
    </div>
    {% endif %}

    <div class="card shadow-sm">
        <div class="card-header bg-light">
            <h5 class="mb-0">Информация об операции</h5>
        </div>
        <div class="card-body">
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                
                <div class="row g-3">
                    <!-- Тип операции -->
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="id_movement_type" class="form-label">Тип операции:</label>
                            <select name="movement_type" id="id_movement_type" class="form-select" required>
                                <option value="">-- Выберите тип операции --</option>
                                {% for value, text in form.fields.movement_type.choices %}
                                    <option value="{{ value }}" {% if form.movement_type.value == value %}selected{% endif %}>{{ text }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <!-- Дата -->
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="id_date" class="form-label">Дата:</label>
                            <input type="date" name="date" id="id_date" class="form-control" value="{{ form.date.value|date:'Y-m-d'|default:'' }}" required>
                        </div>
                    </div>
                    
                    <!-- Продукт -->
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="id_product" class="form-label">Продукт:</label>
                            <select name="product" id="id_product" class="form-select" required>
                                <option value="">-- Выберите продукт --</option>
                                {% for product in form.fields.product.queryset %}
                                    <option value="{{ product.id }}" {% if form.product.value == product.id %}selected{% endif %}>{{ product.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <!-- Номер документа -->
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="id_document_number" class="form-label">Номер документа:</label>
                            <input type="text" name="document_number" id="id_document_number" class="form-control" value="{{ form.document_number.value|default:'' }}">
                        </div>
                    </div>

                    <!-- Ожидаемое количество (тонны) - скрытое поле, будет заполняться скриптом -->
                    <div class="col-md-6 d-none">
                        <div class="form-group">
                            <label for="id_expected_quantity" class="form-label">Ожидаемое количество (тонны):</label>
                            <input type="number" name="expected_quantity" id="id_expected_quantity" step="0.001" class="form-control" value="{{ form.expected_quantity.value|default:'' }}">
                        </div>
                    </div>
                    <!-- Скрытое поле для JSON данных о транспортных средствах -->
                    <input type="hidden" name="transports_json" id="sales-transports-json" value="{{ form.transports_json.value|default:'' }}">
                </div>
                
                <!-- Разделы в зависимости от типа операции -->
                <!-- 1. Приёмка (in) -->
                <div id="reception-fields" class="col-12 operation-fields">
                    <div class="card mb-3">
                        <div class="card-header bg-success bg-opacity-10">
                            <h5 class="mb-0">Данные о приемке</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <!-- Тип клиента -->
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="id_client_type" class="form-label">Тип клиента:</label>
                                        <select name="client_type" id="id_client_type" class="form-select" required>
                                            <option value="">-- Выберите тип клиента --</option>
                                            {% for value, text in form.fields.client_type.choices %}
                                                <option value="{{ value }}" {% if form.client_type.value == value %}selected{% endif %}>{{ text }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <!-- Клиент -->
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="id_client" class="form-label">Клиент:</label>
                                        <select name="client" id="id_client" class="form-select" required>
                                            <option value="">-- Выберите клиента --</option>
                                            {% for client in form.fields.client.queryset %}
                                                <option value="{{ client.id }}" {% if form.client.value == client.id %}selected{% endif %}>{{ client.title }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Блок "Куда поместить продукт" -->
                    <div class="card mb-3 p-3" id="target_storage_section">
                        <h5>Куда поместить продукт</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card p-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="target_type" id="target_reservoir" value="reservoir">
                                        <label class="form-check-label" for="target_reservoir">
                                            Резервуар
                                        </label>
                                    </div>
                                    <div class="mt-2">
                                        <select class="form-select target-select" name="target_reservoir" data-target-type="reservoir" disabled>
                                            <option value="">Выберите резервуар</option>
                                            {% for reservoir in form.reservoirs %}
                                            <option value="{{ reservoir.id }}" {% if form.target_reservoir.value == reservoir.id %}selected{% endif %}>{{ reservoir.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card p-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="target_type" id="target_wagon" value="wagon">
                                        <label class="form-check-label" for="target_wagon">
                                            Вагон
                                        </label>
                                    </div>
                                    <div class="mt-2">
                                        <select class="form-select target-select" name="target_wagon" data-target-type="wagon" disabled>
                                            <option value="">Выберите вагон</option>
                                            {% for wagon in form.wagons %}
                                            <option value="{{ wagon.id }}" {% if form.target_wagon.value == wagon.id %}selected{% endif %}>{{ wagon.wagon_number }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Транспортные средства для приемки -->
                    <div class="card mb-3">
                        <div class="card-header bg-success bg-opacity-10 d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Транспортные средства для приемки</h5>
                            <button type="button" class="btn btn-success btn-sm" id="add-reception-transport">
                                <i class="bi bi-plus-circle"></i> Добавить транспорт
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="reception-transports-container">
                                <div class="reception-transport-entry card mb-3" data-index="0">
                                    <div class="card-header bg-light d-flex justify-content-between align-items-center py-2">
                                        <h6 class="mb-0">Транспорт #<span class="transport-number">1</span></h6>
                                        <button type="button" class="btn btn-danger btn-sm remove-reception-transport" style="display:none">
                                            <i class="bi bi-x-circle"></i>
                                        </button>
                                    </div>
                                    <div class="card-body">
                                        <div class="row g-3">
                                            <!-- Тип транспорта -->
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label class="form-label">Тип транспорта:</label>
                                                    <select class="form-select reception-transport-type" name="reception_transport_type_0" required>
                                                        <option value="">-- Выберите тип --</option>
                                                        <option value="truck">Грузовик</option>
                                                        <option value="wagon">Вагон</option>
                                                    </select>
                                                </div>
                                            </div>
                                            
                                            <!-- Номер транспорта (общее поле) -->
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label class="form-label">Номер транспорта:</label>
                                                    <input type="text" class="form-control reception-transport-number" name="reception_transport_number_0" required>
                                                </div>
                                            </div>
                                            
                                            <!-- Поля для вагонов -->
                                            <div class="col-md-6 wagon-specific-field">
                                                <div class="form-group">
                                                    <label class="form-label">Тип вагона:</label>
                                                    <select class="form-select" name="reception_wagon_type_0">
                                                        <option value="">-- Выберите тип вагона --</option>
                                                        {% for wagon_type in form.wagon_types %}
                                                            <option value="{{ wagon_type.id }}">{{ wagon_type.name }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                            </div>
                                            
                                            <!-- Поля для грузовиков -->
                                            <div class="col-md-6 truck-specific-field">
                                                <div class="form-group">
                                                    <label class="form-label">Грузоподъемность (кг):</label>
                                                    <input type="number" class="form-control" name="reception_truck_capacity_0" step="0.001">
                                                </div>
                                            </div>
                                            
                                            <!-- Вес по документу (кг) -->
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label class="form-label">Вес по документу (кг):</label>
                                                    <input type="number" class="form-control reception-doc-mass" name="reception_doc_mass_0" step="0.001" required>
                                                </div>
                                            </div>
                                            
                                            <!-- Фактический вес (кг) -->
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label class="form-label">Фактический вес (кг):</label>
                                                    <input type="number" class="form-control reception-mass-input" name="reception_mass_0" step="0.001" required>
                                                </div>
                                            </div>
                                            
                                            <!-- Разница -->
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label class="form-label">Разница (кг):</label>
                                                    <input type="number" class="form-control reception-diff-mass" name="reception_diff_mass_0" step="0.001" readonly>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Итоговая информация по приемке -->
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Итоговая информация</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label class="form-label">Общий вес по документам (кг):</label>
                                                <input type="number" id="reception-total-doc-mass" class="form-control" readonly>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label class="form-label">Общий фактический вес (кг):</label>
                                                <input type="number" id="reception-total-mass" class="form-control" readonly>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label class="form-label">Общая разница (кг):</label>
                                                <input type="number" id="reception-total-diff-mass" class="form-control" readonly>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 2. Продажа (out) -->
                <div id="sales-fields" class="col-12 operation-fields">
                    <div class="card mb-3">
                        <div class="card-header bg-warning bg-opacity-10">
                            <h5 class="mb-0">Данные о продаже</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <!-- Тип клиента -->
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="id_client_type_sale" class="form-label">Тип клиента:</label>
                                        <select name="client_type" id="id_client_type_sale" class="form-select" required>
                                            <option value="">-- Выберите тип клиента --</option>
                                            {% for value, text in form.fields.client_type.choices %}
                                                <option value="{{ value }}" {% if form.client_type.value == value %}selected{% endif %}>{{ text }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Клиент -->
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="id_client_sale" class="form-label">Клиент:</label>
                                        <select name="client" id="id_client_sale" class="form-select" required>
                                            <option value="">-- Выберите клиента --</option>
                                            {% for client in form.fields.client.queryset %}
                                                <option value="{{ client.id }}" {% if form.client.value == client.id %}selected{% endif %}>{{ client.title }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Источник (откуда отгружаем) -->
                    <div class="card mb-3">
                        <div class="card-header bg-warning bg-opacity-10">
                            <h5 class="mb-0">Источник (откуда отгружаем)</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-header bg-light">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="source_type" id="source_type_reservoir" value="reservoir" checked>
                                                <label class="form-check-label" for="source_type_reservoir">
                                                    <strong>Резервуар</strong>
                                                </label>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="form-group">
                                                <label for="id_source_reservoir" class="form-label">Выберите резервуар:</label>
                                                <select name="source_reservoir" id="id_source_reservoir" class="form-select source-select" data-source-type="reservoir">
                                                    <option value="">-- Выберите резервуар --</option>
                                                    {% for reservoir in form.reservoirs %}
                                                    <option value="{{ reservoir.id }}" {% if form.source_reservoir.value == reservoir.id %}selected{% endif %}>{{ reservoir.name }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-header bg-light">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="source_type" id="source_type_wagon" value="wagon">
                                                <label class="form-check-label" for="source_type_wagon">
                                                    <strong>Вагон</strong>
                                                </label>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="form-group">
                                                <label for="id_source_wagon" class="form-label">Выберите вагон:</label>
                                                <select name="source_wagon" id="id_source_wagon" class="form-select source-select" data-source-type="wagon">
                                                    <option value="">-- Выберите вагон --</option>
                                                    {% for wagon in form.wagons %}
                                                    <option value="{{ wagon.id }}" {% if form.source_wagon.value == wagon.id %}selected{% endif %}>{{ wagon.wagon_number }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Транспортные средства для отгрузки (без номера, плотности и температуры) -->
                    <div class="card mb-3">
                        <div class="card-header bg-warning bg-opacity-10 d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Транспортные средства для отгрузки</h5>
                            <button type="button" class="btn btn-warning btn-sm" id="add-sales-transport">
                                <i class="bi bi-plus-circle"></i> Добавить транспорт
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="sales-transports-container">
                                <div class="sales-transport-entry card mb-3" data-index="0">
                                    <div class="card-header bg-light d-flex justify-content-between align-items-center py-2">
                                        <h6 class="mb-0">Транспорт #<span class="transport-number">1</span></h6>
                                        <button type="button" class="btn btn-danger btn-sm remove-sales-transport" style="display:none">
                                            <i class="bi bi-x-circle"></i>
                                        </button>
                                    </div>
                                    <div class="card-body">
                                        <div class="row g-3">
                                            <!-- Тип транспорта -->
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label class="form-label">Тип транспорта:</label>
                                                    <select class="form-select sales-transport-type" name="sales_transport_type_0" required>
                                                        <option value="">-- Выберите тип --</option>
                                                        <option value="truck">Грузовик</option>
                                                        <option value="wagon">Вагон</option>
                                                    </select>
                                                </div>
                                            </div>
                                            
                                            <!-- Номер транспорта (общее поле) -->
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label class="form-label">Номер транспорта:</label>
                                                    <input type="text" class="form-control sales-transport-number" name="sales_transport_number_0" required>
                                                </div>
                                            </div>
                                            
                                            <!-- Поля для вагонов -->
                                            <div class="col-md-6 wagon-specific-field">
                                                <div class="form-group">
                                                    <label class="form-label">Тип вагона:</label>
                                                    <select class="form-select" name="sales_wagon_type_0">
                                                        <option value="">-- Выберите тип вагона --</option>
                                                        {% for wagon_type in form.wagon_types %}
                                                            <option value="{{ wagon_type.id }}">{{ wagon_type.name }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                            </div>
                                            
                                            <!-- Поля для грузовиков -->
                                            <div class="col-md-6 truck-specific-field">
                                                <div class="form-group">
                                                    <label class="form-label">Грузоподъемность (кг):</label>
                                                    <input type="number" class="form-control" name="sales_truck_capacity_0" step="0.001">
                                                </div>
                                            </div>
                                            
                                            <!-- Вес по документу (кг) -->
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label class="form-label">Вес по документу (кг):</label>
                                                    <input type="number" class="form-control sales-doc-mass" name="sales_doc_mass_0" step="0.001" required>
                                                </div>
                                            </div>
                                            
                                            <!-- Фактический вес (кг) -->
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label class="form-label">Фактический вес (кг):</label>
                                                    <input type="number" class="form-control sales-mass-input" name="sales_mass_0" step="0.001" required>
                                                </div>
                                            </div>
                                            
                                            <!-- Разница -->
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label class="form-label">Разница (кг):</label>
                                                    <input type="number" class="form-control sales-diff-mass" name="sales_diff_mass_0" step="0.001" readonly>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Итоговая информация по продаже -->
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Итоговая информация</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label class="form-label">Общий вес по документам (кг):</label>
                                                <input type="number" id="sales-total-doc-mass" class="form-control" readonly>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label class="form-label">Общий фактический вес (кг):</label>
                                                <input type="number" id="sales-total-mass" class="form-control" readonly>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label class="form-label">Общая разница (кг):</label>
                                                <input type="number" id="sales-total-diff-mass" class="form-control" readonly>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 3. Производство (production) -->
                <div id="production-fields" class="col-12 operation-fields">
                    <div class="card mb-3">
                        <div class="card-header bg-info bg-opacity-10">
                            <h5 class="mb-0">Данные о производстве</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <!-- Производимый продукт -->
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="id_product_production" class="form-label">Производимый продукт:</label>
                                        <select name="product" id="id_product_production" class="form-select" required>
                                            <option value="">-- Выберите продукт --</option>
                                            {% for product in form.fields.product.queryset %}
                                                <option value="{{ product.id }}" {% if form.product.value == product.id %}selected{% endif %}>{{ product.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Дата -->
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="id_date_production" class="form-label">Дата:</label>
                                        <input type="date" name="date" id="id_date_production" class="form-control" value="{{ form.date.value|date:'Y-m-d'|default:'' }}" required>
                                    </div>
                                </div>
                                
                                <!-- Предполагаемый вес (кг) -->
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="id_material_quantity" class="form-label">Предполагаемый вес (кг):</label>
                                        <input type="number" name="material_quantity" id="id_material_quantity" class="form-control" step="0.001" value="{{ form.material_quantity.value|default:'' }}" required>
                                    </div>
                                </div>
                                
                                <!-- Сырье (продукт) -->
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="id_source_product" class="form-label">Сырьё (продукт):</label>
                                        <select name="source_product" id="id_source_product" class="form-select" required>
                                            <option value="">-- Выберите продукт --</option>
                                            {% for product in form.fields.product.queryset %}
                                                <option value="{{ product.id }}" {% if form.source_product.value == product.id %}selected{% endif %}>{{ product.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Откуда брать сырье -->
                    <div class="card mb-3">
                        <div class="card-header bg-info bg-opacity-10">
                            <h5 class="mb-0">Откуда брать сырьё</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <!-- Вариант 1: резервуар -->
                                <div class="col-md-6 mb-3">
                                    <div class="card h-100">
                                        <div class="card-header bg-light">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="source_type_production" id="source_type_reservoir_production" value="reservoir" checked>
                                                <label class="form-check-label" for="source_type_reservoir_production">
                                                    <strong>Резервуар</strong>
                                                </label>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="form-group">
                                                <select name="source_reservoir" id="id_source_reservoir_production" class="form-select production-source-select" data-source-type="reservoir">
                                                    <option value="">-- Выберите резервуар --</option>
                                                    {% for reservoir in form.reservoirs %}
                                                        <option value="{{ reservoir.id }}" {% if form.source_reservoir.value == reservoir.id %}selected{% endif %}>{{ reservoir.name }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Вариант 2: вагон -->
                                <div class="col-md-6 mb-3">
                                    <div class="card h-100">
                                        <div class="card-header bg-light">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="source_type_production" id="source_type_wagon_production" value="wagon">
                                                <label class="form-check-label" for="source_type_wagon_production">
                                                    <strong>Вагон</strong>
                                                </label>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="form-group">
                                                <label for="id_source_wagon_number_production" class="form-label">Номер вагона:</label>
                                                <input type="text" name="source_wagon_number" id="id_source_wagon_number_production" class="form-control production-source-input" data-source-type="wagon" disabled>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Куда поставить результат производства -->
                    <div class="card mb-3">
                        <div class="card-header bg-info bg-opacity-10">
                            <h5 class="mb-0">Куда поставить (результат производства)</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <!-- Вариант 1: резервуар -->
                                <div class="col-md-6 mb-3">
                                    <div class="card h-100">
                                        <div class="card-header bg-light">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="target_type_production" id="target_type_reservoir_production" value="reservoir" checked>
                                                <label class="form-check-label" for="target_type_reservoir_production">
                                                    <strong>Резервуар</strong>
                                                </label>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="form-group">
                                                <select name="target_reservoir" id="id_target_reservoir_production" class="form-select production-target-select" data-target-type="reservoir">
                                                    <option value="">-- Выберите резервуар --</option>
                                                    {% for reservoir in form.reservoirs %}
                                                        <option value="{{ reservoir.id }}" {% if form.target_reservoir.value == reservoir.id %}selected{% endif %}>{{ reservoir.name }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Вариант 2: вагон -->
                                <div class="col-md-6 mb-3">
                                    <div class="card h-100">
                                        <div class="card-header bg-light">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="target_type_production" id="target_type_wagon_production" value="wagon">
                                                <label class="form-check-label" for="target_type_wagon_production">
                                                    <strong>Вагон</strong>
                                                </label>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="row g-2">
                                                <div class="col-12">
                                                    <div class="form-group">
                                                        <label for="id_target_wagon_production" class="form-label">Выбор вагона:</label>
                                                        <select name="target_wagon" id="id_target_wagon_production" class="form-select production-target-select" data-target-type="wagon" disabled>
                                                            <option value="">-- Выберите вагон --</option>
                                                            {% for wagon in form.wagons %}
                                                                <option value="{{ wagon.id }}" {% if form.target_wagon.value == wagon.id %}selected{% endif %}>{{ wagon.wagon_number }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="col-12">
                                                    <div class="form-group">
                                                        <label for="id_target_wagon_type_production" class="form-label">Тип вагона:</label>
                                                        <select name="target_wagon_type" id="id_target_wagon_type_production" class="form-select production-target-wagon-type" disabled>
                                                            <option value="">-- Выберите тип вагона --</option>
                                                            {% for wagon_type in form.wagon_types %}
                                                                <option value="{{ wagon_type.id }}">{{ wagon_type.name }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Комментарий -->
                    <div class="form-group mb-3">
                        <label for="id_note_production" class="form-label">Комментарий:</label>
                        <textarea name="note" id="id_note_production" class="form-control" rows="3">{{ form.note.value|default:'' }}</textarea>
                    </div>
                </div>
                
                <!-- 4. Перемещение (transfer) -->
                <div id="transfer-fields" class="col-12 operation-fields">
                    <div class="row g-3">
                        <!-- Источник (откуда перемещаем) -->
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header bg-info bg-opacity-10">
                                    <h5 class="mb-0">Источник (откуда перемещаем)</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-12">
                                            <div class="form-group">
                                                <label for="id_source_reservoir_transfer" class="form-label">Резервуар:</label>
                                                <select name="source_reservoir" id="id_source_reservoir_transfer" class="form-select">
                                                    <option value="">-- Выберите резервуар --</option>
                                                    {% for reservoir in form.fields.source_reservoir.queryset %}
                                                        <option value="{{ reservoir.id }}" {% if form.source_reservoir.value == reservoir.id %}selected{% endif %}>{{ reservoir.name }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <div class="form-group">
                                                <label for="id_source_wagon_transfer" class="form-label">Вагон:</label>
                                                <select name="source_wagon" id="id_source_wagon_transfer" class="form-select">
                                                    <option value="">-- Выберите вагон --</option>
                                                    {% for wagon in form.fields.source_wagon.queryset %}
                                                        <option value="{{ wagon.id }}" {% if form.source_wagon.value == wagon.id %}selected{% endif %}>{{ wagon.wagon_number }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                        <!-- Новое поле: Количество источника (кг) -->
                                        <div class="col-12">
                                            <div class="form-group">
                                                <label for="id_source_quantity" class="form-label">Количество источника (кг):</label>
                                                <input type="number" name="source_quantity" id="id_source_quantity" class="form-control" step="0.001" value="{{ form.source_quantity.value|default:'' }}" required>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Назначение (куда перемещаем) -->
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header bg-info bg-opacity-10">
                                    <h5 class="mb-0">Назначение (куда перемещаем)</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-12">
                                            <div class="form-group">
                                                <label for="id_target_reservoir_transfer" class="form-label">Резервуар:</label>
                                                <select name="target_reservoir" id="id_target_reservoir_transfer" class="form-select">
                                                    <option value="">-- Выберите резервуар --</option>
                                                    {% for reservoir in form.fields.target_reservoir.queryset %}
                                                        <option value="{{ reservoir.id }}" {% if form.target_reservoir.value == reservoir.id %}selected{% endif %}>{{ reservoir.name }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <div class="form-group">
                                                <label for="id_target_wagon_transfer" class="form-label">Вагон:</label>
                                                <select name="target_wagon" id="id_target_wagon_transfer" class="form-select">
                                                    <option value="">-- Выберите вагон --</option>
                                                    {% for wagon in form.fields.target_wagon.queryset %}
                                                        <option value="{{ wagon.id }}" {% if form.target_wagon.value == wagon.id %}selected{% endif %}>{{ wagon.wagon_number }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                        <!-- Новое поле: Количество назначения (кг) -->
                                        <div class="col-12">
                                            <div class="form-group">
                                                <label for="id_target_quantity" class="form-label">Количество назначения (кг):</label>
                                                <input type="number" name="target_quantity" id="id_target_quantity" class="form-control" step="0.001" value="{{ form.target_quantity.value|default:'' }}" required>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Примечание -->
                <div class="col-12 mt-3">
                    <div class="form-group">
                        <label for="id_note" class="form-label">Примечание:</label>
                        <textarea name="note" id="id_note" class="form-control" rows="3">{{ form.note.value|default:'' }}</textarea>
                    </div>
                </div>
                
                <!-- Кнопки формы -->
                <div class="mt-4 d-flex justify-content-end">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle"></i>
                        {% if movement %}Сохранить изменения{% else %}Создать операцию{% endif %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Функция показа/скрытия блоков в зависимости от типа операции
    function toggleOperationFields() {
        const movementType = document.getElementById('id_movement_type').value;
        
        // Скрываем все блоки операций
        document.querySelectorAll('.operation-fields').forEach(field => {
            field.style.display = 'none';
            
            // Сначала удаляем атрибут required у всех полей
            field.querySelectorAll('input, select').forEach(input => {
                // Запоминаем, было ли поле обязательным (для последующего восстановления)
                if (input.required) {
                    input.setAttribute('data-was-required', 'true');
                    input.required = false;
                }
            });
        });
        
        // Показываем нужный блок и восстанавливаем required для его полей
        if (movementType === 'in') {
            const receptionFields = document.getElementById('reception-fields');
            receptionFields.style.display = 'block';
            
            // Восстанавливаем required для видимых полей
            receptionFields.querySelectorAll('input, select').forEach(input => {
                if (input.getAttribute('data-was-required') === 'true') {
                    input.required = true;
                }
            });
        } else if (movementType === 'out') {
            const salesFields = document.getElementById('sales-fields');
            salesFields.style.display = 'block';
            
            // Восстанавливаем required для видимых полей
            salesFields.querySelectorAll('input, select').forEach(input => {
                if (input.getAttribute('data-was-required') === 'true') {
                    input.required = true;
                }
            });
        } else if (movementType === 'production') {
            const productionFields = document.getElementById('production-fields');
            productionFields.style.display = 'block';
            
            // Восстанавливаем required для видимых полей
            productionFields.querySelectorAll('input, select').forEach(input => {
                if (input.getAttribute('data-was-required') === 'true') {
                    input.required = true;
                }
            });
        } else if (movementType === 'transfer') {
            const transferFields = document.getElementById('transfer-fields');
            transferFields.style.display = 'block';
            
            // Восстанавливаем required для видимых полей
            transferFields.querySelectorAll('input, select').forEach(input => {
                if (input.getAttribute('data-was-required') === 'true') {
                    input.required = true;
                }
            });
        }
    }
    
    const movementTypeSelect = document.getElementById('id_movement_type');
    if (movementTypeSelect) {
        // При изменении типа операции
        movementTypeSelect.addEventListener('change', toggleOperationFields);
        
        // Устанавливаем data-was-required при загрузке страницы
        document.querySelectorAll('.operation-fields input[required], .operation-fields select[required]').forEach(input => {
            input.setAttribute('data-was-required', 'true');
        });
        
        // Инициализация при загрузке страницы
        toggleOperationFields();
    }

    // --- Фильтрация клиентов по типу клиента ---
    function setupClientTypeHandlers() {
        // Общий селектор типа клиента
        const mainClientType = document.getElementById('id_client_type');
        const mainClient = document.getElementById('id_client');
        
        if (mainClientType && mainClient) {
            mainClientType.addEventListener('change', function() {
                filterClientsByType(this.value, mainClient);
            });
            
            // Инициализация при загрузке
            filterClientsByType(mainClientType.value, mainClient);
        }
        
        // Селектор типа клиента для приемки
        const receptionClientType = document.getElementById('id_client_type');
        const receptionClient = document.getElementById('id_client');
        
        if (receptionClientType && receptionClient) {
            receptionClientType.addEventListener('change', function() {
                filterClientsByType(this.value, receptionClient);
            });
        }
        
        // Селектор типа клиента для продажи
        const saleClientType = document.getElementById('id_client_type_sale');
        const saleClient = document.getElementById('id_client_sale');
        
        if (saleClientType && saleClient) {
            saleClientType.addEventListener('change', function() {
                filterClientsByType(this.value, saleClient);
            });
            
            // Инициализация при загрузке
            filterClientsByType(saleClientType.value, saleClient);
        }
    }
    
    function filterClientsByType(clientType, clientSelect) {
        if (!clientType || !clientSelect) return;
        
        // Скрываем все опции, кроме первой (пустой)
        Array.from(clientSelect.options).forEach((option, index) => {
            if (index === 0) {
                // Оставляем первую опцию видимой
                option.style.display = '';
            } else {
                // Скрываем остальные опции по умолчанию
                option.style.display = 'none';
                
                // В реальном приложении здесь должен быть код для фильтрации по типу клиента
                // Для примера, будем показывать все опции с четными индексами для local, 
                // и с нечетными для international
                const isLocal = clientType === 'local';
                const isInternational = clientType === 'international';
                
                if ((isLocal && index % 2 === 0) || (isInternational && index % 2 !== 0)) {
                    option.style.display = '';
                }
            }
        });
        
        // Сбрасываем выбор, если выбранный элемент больше не виден
        if (clientSelect.selectedIndex > 0 && 
            clientSelect.options[clientSelect.selectedIndex].style.display === 'none') {
            clientSelect.selectedIndex = 0;
        }
    }
    
    setupClientTypeHandlers();

    // --- Функционал для работы с транспортом в продаже ---
    let salesTransportCounter = 1;
    
    function setupSalesTransport() {
        const addSalesTransportBtn = document.getElementById('add-sales-transport');
        if (addSalesTransportBtn) {
            addSalesTransportBtn.addEventListener('click', function() {
                addSalesTransportEntry();
            });
        }
        
        // Инициализируем обработчики для существующих транспортов
        setupSalesEventHandlers();
    }
    
    function addSalesTransportEntry() {
        const container = document.getElementById('sales-transports-container');
        if (!container) return;
        
        const transportEntries = container.querySelectorAll('.sales-transport-entry');
        if (transportEntries.length === 0) return;
        
        const lastEntry = transportEntries[transportEntries.length - 1];
        const newEntry = lastEntry.cloneNode(true);
        
        salesTransportCounter++;
        newEntry.setAttribute('data-index', salesTransportCounter - 1);
        
        // Обновляем номер транспорта
        const transportNumberEl = newEntry.querySelector('.transport-number');
        if (transportNumberEl) {
            transportNumberEl.textContent = salesTransportCounter;
        }
        
        // Очищаем значения полей ввода
        newEntry.querySelectorAll('input').forEach(input => {
            input.value = '';
            
            // Для полей только для чтения (разница) не очищаем
            if (input.classList.contains('sales-diff-mass')) {
                input.value = '0.000';
            }
            
            // Обновляем имя поля с новым индексом
            const name = input.getAttribute('name');
            if (name) {
                const baseName = name.split('_').slice(0, -1).join('_');
                input.setAttribute('name', `${baseName}_${salesTransportCounter - 1}`);
            }
        });
        
        // Обновляем селекты
        newEntry.querySelectorAll('select').forEach(select => {
            select.selectedIndex = 0;
            
            // Обновляем имя селекта с новым индексом
            const name = select.getAttribute('name');
            if (name) {
                const baseName = name.split('_').slice(0, -1).join('_');
                select.setAttribute('name', `${baseName}_${salesTransportCounter - 1}`);
            }
        });
        
        // Показываем кнопку удаления
        const removeBtn = newEntry.querySelector('.remove-sales-transport');
        if (removeBtn) {
            removeBtn.style.display = 'block';
        }
        
        // Добавляем новую запись
        container.appendChild(newEntry);
        
        // Получаем тип транспорта в новой записи
        const transportTypeSelect = newEntry.querySelector('.sales-transport-type');
        if (transportTypeSelect) {
            // Инициализируем видимость полей в зависимости от выбранного типа
            toggleTransportFields(newEntry, transportTypeSelect.value);
            
            // Добавляем обработчик события изменения типа транспорта
            transportTypeSelect.addEventListener('change', function() {
                toggleTransportFields(newEntry, this.value);
            });
        }
        
        // Обновляем обработчики событий и пересчитываем итоги
        setupSalesEventHandlers();
        setupMassCalculation(); // Добавляем обработчики для новых полей массы
        updateTotalMass('sales');
    }
    
    function setupSalesEventHandlers() {
        // Добавляем обработчики для удаления транспорта
        document.querySelectorAll('.remove-sales-transport').forEach(button => {
            button.onclick = function() {
                const transportEntry = this.closest('.sales-transport-entry');
                if (transportEntry) {
                    transportEntry.remove();
                    updateSalesTransportNumbers();
                    updateTotalMass('sales');
                    updateTransportsJson();
                }
            };
        });

        // Добавляем обработчики для изменения типа транспорта
        document.querySelectorAll('.sales-transport-type').forEach(select => {
            const transportEntry = select.closest('.sales-transport-entry');
            if (transportEntry) {
                select.onchange = function() {
                    toggleTransportFields(transportEntry, this.value);
                    updateTransportsJson();
                };
            }
        });

        // Добавляем обработчики для всех полей ввода в транспортных секциях
        document.querySelectorAll('.sales-transport-entry input, .sales-transport-entry select').forEach(element => {
            element.addEventListener('change', function() {
                updateTransportsJson();
            });
            if (element.tagName === 'INPUT') {
                element.addEventListener('input', function() {
                    updateTransportsJson();
                });
            }
        });
    }
    
    function updateSalesTransportNumbers() {
        let counter = 1;
        document.querySelectorAll('.sales-transport-entry').forEach(entry => {
            const transportNumberEl = entry.querySelector('.transport-number');
            if (transportNumberEl) {
                transportNumberEl.textContent = counter++;
            }
        });
        salesTransportCounter = counter - 1;
    }
    
    function updateSalesTotalMass() {
        updateTotalMass('sales');
    }
    
    setupSalesTransport();
    
    // Устанавливаем обработчики для расчета разницы весов
    function setupMassCalculation() {
        // Обработчики для ввода данных о массе
        document.querySelectorAll('.sales-doc-mass, .sales-mass-input, .reception-doc-mass, .reception-mass-input').forEach(input => {
            input.addEventListener('input', function() {
                const entry = this.closest('.sales-transport-entry, .reception-transport-entry');
                if (entry) {
                    const entryClass = entry.classList.contains('sales-transport-entry') ? 'sales' : 'reception';
                    const massInput = entry.querySelector(`.${entryClass}-mass-input`);
                    const docMassInput = entry.querySelector(`.${entryClass}-doc-mass`);
                    const diffMassInput = entry.querySelector(`.${entryClass}-diff-mass`);
                    
                    if (massInput && docMassInput && diffMassInput) {
                        const mass = parseFloat(massInput.value) || 0;
                        const docMass = parseFloat(docMassInput.value) || 0;
                        const diff = mass - docMass;
                        
                        // Обновляем поле разницы
                        diffMassInput.value = diff.toFixed(3);
                    }
                }
                
                // Обновляем общие данные
                updateTotalMass(entryClass);
            });
        });
    }
    
    setupMassCalculation();
    
    // Единая функция для обновления общей массы
    function updateTotalMass(type) {
        const prefix = type || 'sales';
        let totalMass = 0;
        let totalDocMass = 0;
        let totalDiffMass = 0;
        const transportsData = [];
        
        document.querySelectorAll(`.${prefix}-transport-entry`).forEach(entry => {
            const massInput = entry.querySelector(`.${prefix}-mass-input`);
            const transportTypeSelect = entry.querySelector(`.${prefix}-transport-type`);
            const transportNumberInput = entry.querySelector(`.${prefix}-transport-number`);
            const docMassInput = entry.querySelector(`.${prefix}-doc-mass`);
            const diffMassInput = entry.querySelector(`.${prefix}-diff-mass`);
            
            if (massInput && transportTypeSelect && transportNumberInput && docMassInput && diffMassInput) {
                const mass = parseFloat(massInput.value) || 0;
                const docMass = parseFloat(docMassInput.value) || 0;
                const diff = mass - docMass;
                
                // Обновляем поле разницы
                diffMassInput.value = diff.toFixed(3);
                
                totalMass += mass;
                totalDocMass += docMass;
                totalDiffMass += diff;
                
                // Соберем данные в зависимости от типа транспорта
                const transportData = {
                    transport_type: transportTypeSelect.value,
                    transport_number: transportNumberInput.value,
                    doc_mass: docMass,
                    mass: mass,
                    diff: diff
                };
                
                // Добавляем специфичные для типа транспорта данные
                if (transportTypeSelect.value === 'wagon') {
                    const wagonTypeSelect = entry.querySelector(`[name^="${prefix}_wagon_type_"]`);
                    if (wagonTypeSelect) {
                        transportData.wagon_type = wagonTypeSelect.value;
                    }
                } else if (transportTypeSelect.value === 'truck') {
                    const truckCapacityInput = entry.querySelector(`[name^="${prefix}_truck_capacity_"]`);
                    if (truckCapacityInput) {
                        transportData.truck_capacity = parseFloat(truckCapacityInput.value) || 0;
                    }
                }
                
                transportsData.push(transportData);
            }
        });
        
        // Обновляем общие суммы
        const totalMassElement = document.getElementById(`${prefix}-total-mass`);
        if (totalMassElement) {
            totalMassElement.value = totalMass.toFixed(3);
        }
        
        const totalDocMassElement = document.getElementById(`${prefix}-total-doc-mass`);
        if (totalDocMassElement) {
            totalDocMassElement.value = totalDocMass.toFixed(3);
        }
        
        const totalDiffMassElement = document.getElementById(`${prefix}-total-diff-mass`);
        if (totalDiffMassElement) {
            totalDiffMassElement.value = totalDiffMass.toFixed(3);
        }
        
        // Сохраняем данные в скрытом поле JSON
        updateTransportsJson(transportsData);
        
        // Обновляем поле expected_quantity
        const expectedQuantityElement = document.getElementById('id_expected_quantity');
        if (expectedQuantityElement) {
            // Конвертируем кг в тонны для поля формы
            expectedQuantityElement.value = (totalMass / 1000).toFixed(3);
        }
    }
    
    function updateTransportsJson(transportsData) {
        // Если данные не переданы, соберем их с формы
        if (!transportsData) {
            let currentType = document.getElementById('id_movement_type').value;
            transportsData = [];
            
            // Определяем префикс и контейнер в зависимости от типа операции
            let prefix, container;
            if (currentType === 'in') {
                prefix = 'reception';
                container = document.getElementById('reception-transports-container');
            } else if (currentType === 'out') {
                prefix = 'sales';
                container = document.getElementById('sales-transports-container');
            } else {
                // Для остальных типов операций данные о транспортах не нужны
                return;
            }
            
            // Собираем данные о транспортах
            if (container) {
                container.querySelectorAll(`.${prefix}-transport-entry`).forEach(entry => {
                    const transportType = entry.querySelector(`.${prefix}-transport-type`).value;
                    const transportNumber = entry.querySelector(`.${prefix}-transport-number`).value;
                    const docMass = parseFloat(entry.querySelector(`.${prefix}-doc-mass`).value) || 0;
                    const mass = parseFloat(entry.querySelector(`.${prefix}-mass-input`).value) || 0;
                    const diffMass = parseFloat(entry.querySelector(`.${prefix}-diff-mass`).value) || 0;
                    
                    // Только если есть транспортное средство и вес
                    if (transportType && transportNumber && mass > 0) {
                        // Базовые данные о транспорте
                        const transportData = {
                            transport_type: transportType,
                            transport_number: transportNumber,
                            doc_mass: docMass,  // в кг
                            mass: mass,         // в кг
                            diff: diffMass      // в кг
                        };
                        
                        // Добавляем специфичные для типа транспорта данные
                        if (transportType === 'wagon') {
                            const wagonTypeSelect = entry.querySelector(`[name^="${prefix}_wagon_type_"]`);
                            if (wagonTypeSelect) {
                                transportData.wagon_type = wagonTypeSelect.value;
                            }
                        } else if (transportType === 'truck') {
                            const truckCapacityInput = entry.querySelector(`[name^="${prefix}_truck_capacity_"]`);
                            if (truckCapacityInput) {
                                transportData.truck_capacity = parseFloat(truckCapacityInput.value) || 0;
                            }
                        }
                        
                        transportsData.push(transportData);
                    }
                });
            }
        }
        
        // Сохраняем в скрытое поле формы
        const jsonElement = document.getElementById('sales-transports-json');
        if (jsonElement) {
            jsonElement.value = JSON.stringify(transportsData);
        }
    }
    
    // Функции для работы с транспортными средствами приемки
    let receptionTransportCounter = 1;
    
    function setupReceptionTransport() {
        const addReceptionTransportBtn = document.getElementById('add-reception-transport');
        if (addReceptionTransportBtn) {
            addReceptionTransportBtn.addEventListener('click', function() {
                addReceptionTransportEntry();
            });
        }
        
        // Инициализируем обработчики для существующих транспортов приемки
        setupReceptionEventHandlers();
    }
    
    function addReceptionTransportEntry() {
        const container = document.getElementById('reception-transports-container');
        if (!container) return;
        
        const transportEntries = container.querySelectorAll('.reception-transport-entry');
        if (transportEntries.length === 0) return;
        
        const lastEntry = transportEntries[transportEntries.length - 1];
        const newEntry = lastEntry.cloneNode(true);
        
        receptionTransportCounter++;
        newEntry.setAttribute('data-index', receptionTransportCounter - 1);
        
        // Обновляем номер транспорта
        const transportNumberEl = newEntry.querySelector('.transport-number');
        if (transportNumberEl) {
            transportNumberEl.textContent = receptionTransportCounter;
        }
        
        // Очищаем значения полей ввода
        newEntry.querySelectorAll('input').forEach(input => {
            input.value = '';
            
            // Для полей только для чтения (разница) не очищаем
            if (input.classList.contains('reception-diff-mass')) {
                input.value = '0.000';
            }
            
            // Обновляем имя поля с новым индексом
            const name = input.getAttribute('name');
            if (name) {
                const baseName = name.split('_').slice(0, -1).join('_');
                input.setAttribute('name', `${baseName}_${receptionTransportCounter - 1}`);
            }
        });
        
        // Обновляем селекты
        newEntry.querySelectorAll('select').forEach(select => {
            select.selectedIndex = 0;
            
            // Обновляем имя селекта с новым индексом
            const name = select.getAttribute('name');
            if (name) {
                const baseName = name.split('_').slice(0, -1).join('_');
                select.setAttribute('name', `${baseName}_${receptionTransportCounter - 1}`);
            }
        });
        
        // Показываем кнопку удаления
        const removeBtn = newEntry.querySelector('.remove-reception-transport');
        if (removeBtn) {
            removeBtn.style.display = 'block';
        }
        
        // Добавляем новую запись
        container.appendChild(newEntry);
        
        // Инициализируем обработчики для новой записи
        setupReceptionEventHandlers();
        // Обновляем общие данные
        updateTotalMass('reception');
    }
    
    function setupReceptionEventHandlers() {
        // Обработчики для кнопок удаления транспорта
        document.querySelectorAll('.remove-reception-transport').forEach(button => {
            // Удаляем существующие обработчики
            const newButton = button.cloneNode(true);
            if (button.parentNode) {
                button.parentNode.replaceChild(newButton, button);
            }
            
            // Добавляем новый обработчик
            newButton.addEventListener('click', function() {
                const entry = this.closest('.reception-transport-entry');
                if (entry) {
                    entry.remove();
                    updateReceptionTransportNumbers();
                    updateTotalMass('reception');
                }
            });
        });
        
        // Обработчики для полей ввода массы
        document.querySelectorAll('.reception-mass-input, .reception-doc-mass').forEach(input => {
            input.addEventListener('input', function() {
                updateTotalMass('reception');
            });
        });
        
        // Обработчики для селекторов типа транспорта
        document.querySelectorAll('.reception-transport-type').forEach(select => {
            select.addEventListener('change', function() {
                const transportEntry = this.closest('.reception-transport-entry');
                if (transportEntry) {
                    toggleTransportFields(transportEntry, this.value);
                }
            });
            
            // Инициализируем состояние полей при загрузке
            const transportEntry = select.closest('.reception-transport-entry');
            if (transportEntry) {
                toggleTransportFields(transportEntry, select.value);
            }
        });
    }
    
    function updateReceptionTransportNumbers() {
        let counter = 1;
        document.querySelectorAll('.reception-transport-entry').forEach(entry => {
            const transportNumberEl = entry.querySelector('.transport-number');
            if (transportNumberEl) {
                transportNumberEl.textContent = counter++;
            }
        });
        receptionTransportCounter = counter - 1;
    }
    
    // Инициализируем обработчики для транспортных средств приемки
    setupReceptionTransport();

    // Инициализация обработчиков для источника товара
    function setupSourceSelectionHandlers() {
        // Радиокнопки для выбора типа источника
        const sourceTypeRadios = document.querySelectorAll('input[name="source_type"]');
        // Селекторы источников (резервуар и вагон)
        const sourceSelects = document.querySelectorAll('.source-select');
        
        // Обработчик изменения типа источника
        sourceTypeRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                // Определяем выбранный тип источника
                const selectedSourceType = this.value;
                
                // Деактивируем все селекторы источников
                sourceSelects.forEach(select => {
                    const selectSourceType = select.getAttribute('data-source-type');
                    
                    // Если тип источника совпадает с выбранным, активируем селектор
                    if (selectSourceType === selectedSourceType) {
                        select.disabled = false;
                        select.closest('.card').classList.add('border-primary');
                    } else {
                        // Иначе деактивируем и очищаем
                        select.disabled = true;
                        select.value = '';
                        select.closest('.card').classList.remove('border-primary');
                    }
                });
            });
        });
        
        // Проверяем начальное состояние
        const checkedRadio = document.querySelector('input[name="source_type"]:checked');
        if (checkedRadio) {
            // Имитируем событие change для установки начального состояния
            checkedRadio.dispatchEvent(new Event('change'));
        }
        
        // Предотвращаем одновременный выбор нескольких источников при прямом взаимодействии с селекторами
        sourceSelects.forEach(select => {
            select.addEventListener('change', function() {
                if (this.value) {
                    // Активируем соответствующую радиокнопку
                    const sourceType = this.getAttribute('data-source-type');
                    const radio = document.querySelector(`input[name="source_type"][value="${sourceType}"]`);
                    if (radio) {
                        radio.checked = true;
                        radio.dispatchEvent(new Event('change'));
                    }
                }
            });
        });
    }
    
    setupSourceSelectionHandlers();

    // Обработчики для целевого места хранения в блоке приемки
    function setupTargetSelectionHandlers() {
        // Радиокнопки для выбора типа целевого хранилища
        const targetTypeRadios = document.querySelectorAll('input[name="target_type"]');
        // Селекторы целевых хранилищ (резервуар и вагон)
        const targetSelects = document.querySelectorAll('.target-select');
        
        // Обработчик изменения типа целевого хранилища
        targetTypeRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                // Определяем выбранный тип хранилища
                const selectedTargetType = this.value;
                
                // Деактивируем все селекторы хранилищ
                targetSelects.forEach(select => {
                    const selectTargetType = select.getAttribute('data-target-type');
                    
                    // Если тип хранилища совпадает с выбранным, активируем селектор
                    if (selectTargetType === selectedTargetType) {
                        select.disabled = false;
                        select.closest('.card').classList.add('border-primary');
                    } else {
                        // Иначе деактивируем и очищаем
                        select.disabled = true;
                        select.value = '';
                        select.closest('.card').classList.remove('border-primary');
                    }
                });
            });
        });
        
        // Проверяем начальное состояние
        const checkedRadio = document.querySelector('input[name="target_type"]:checked');
        if (checkedRadio) {
            // Имитируем событие change для установки начального состояния
            checkedRadio.dispatchEvent(new Event('change'));
        }
        
        // Предотвращаем одновременный выбор нескольких хранилищ при прямом взаимодействии с селекторами
        targetSelects.forEach(select => {
            select.addEventListener('change', function() {
                if (this.value) {
                    // Активируем соответствующую радиокнопку
                    const targetType = this.getAttribute('data-target-type');
                    const radio = document.querySelector(`input[name="target_type"][value="${targetType}"]`);
                    if (radio) {
                        radio.checked = true;
                        radio.dispatchEvent(new Event('change'));
                    }
                }
            });
        });
    }
    
    setupTargetSelectionHandlers();

    // Обработчики для полей перемещения
    function setupTransferHandlers() {
        const sourceQuantityInput = document.getElementById('id_source_quantity');
        if (sourceQuantityInput) {
            sourceQuantityInput.addEventListener('input', function() {
                // При вводе количества источника, обновляем ожидаемое количество в тоннах
                const sourceValue = parseFloat(this.value) || 0;
                const expectedQuantityInput = document.getElementById('id_expected_quantity');
                if (expectedQuantityInput) {
                    // Преобразуем кг в тонны
                    expectedQuantityInput.value = (sourceValue / 1000).toFixed(3);
                }
            });
        }
    }
    
    setupTransferHandlers();
    
    // Обработчики для полей производства
    function setupProductionHandlers() {
        const materialQuantityInput = document.getElementById('id_material_quantity');
        const sourceQuantityInput = document.getElementById('id_source_quantity');
        
        if (materialQuantityInput) {
            materialQuantityInput.addEventListener('input', function() {
                // При вводе массы продукта в кг, обновляем ожидаемое количество в тоннах
                const materialValue = parseFloat(this.value) || 0;
                const expectedQuantityInput = document.getElementById('id_expected_quantity');
                if (expectedQuantityInput) {
                    // Преобразуем кг в тонны
                    expectedQuantityInput.value = (materialValue / 1000).toFixed(3);
                }
            });
        }
        
        if (sourceQuantityInput) {
            sourceQuantityInput.addEventListener('input', function() {
                // При необходимости можно добавить дополнительную логику обработки
            });
        }
        
        // Обработчики для выбора источника сырья в производстве
        setupProductionSourceHandlers();
        
        // Обработчики для выбора назначения в производстве
        setupProductionTargetHandlers();
    }
    
    // Обработчики для выбора источника сырья в производстве
    function setupProductionSourceHandlers() {
        const sourceTypeRadios = document.querySelectorAll('input[name="source_type_production"]');
        const sourceSelects = document.querySelectorAll('.production-source-select');
        const sourceInputs = document.querySelectorAll('.production-source-input');
        
        sourceTypeRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                const selectedSourceType = this.value;
                
                // Деактивируем все селекты и инпуты
                sourceSelects.forEach(select => {
                    const selectSourceType = select.getAttribute('data-source-type');
                    select.disabled = selectSourceType !== selectedSourceType;
                    
                    if (selectSourceType !== selectedSourceType) {
                        select.value = '';
                    }
                });
                
                sourceInputs.forEach(input => {
                    const inputSourceType = input.getAttribute('data-source-type');
                    input.disabled = inputSourceType !== selectedSourceType;
                    
                    if (inputSourceType !== selectedSourceType) {
                        input.value = '';
                    }
                });
            });
        });
        
        // Инициализация при загрузке страницы
        const checkedSourceTypeRadio = document.querySelector('input[name="source_type_production"]:checked');
        if (checkedSourceTypeRadio) {
            checkedSourceTypeRadio.dispatchEvent(new Event('change'));
        }
    }
    
    // Обработчики для выбора назначения в производстве
    function setupProductionTargetHandlers() {
        const targetTypeRadios = document.querySelectorAll('input[name="target_type_production"]');
        const targetSelects = document.querySelectorAll('.production-target-select');
        const targetWagonTypeSelect = document.querySelector('.production-target-wagon-type');
        
        targetTypeRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                const selectedTargetType = this.value;
                
                // Деактивируем все селекты
                targetSelects.forEach(select => {
                    const selectTargetType = select.getAttribute('data-target-type');
                    select.disabled = selectTargetType !== selectedTargetType;
                    
                    if (selectTargetType !== selectedTargetType) {
                        select.value = '';
                    }
                });
                
                // Активируем/деактивируем выбор типа вагона
                if (selectedTargetType === 'wagon' && targetWagonTypeSelect) {
                    targetWagonTypeSelect.disabled = false;
                } else if (targetWagonTypeSelect) {
                    targetWagonTypeSelect.disabled = true;
                    targetWagonTypeSelect.value = '';
                }
            });
        });
        
        // Инициализация при загрузке страницы
        const checkedTargetTypeRadio = document.querySelector('input[name="target_type_production"]:checked');
        if (checkedTargetTypeRadio) {
            checkedTargetTypeRadio.dispatchEvent(new Event('change'));
        }
    }
    
    // Инициализация обработчиков для полей производства
    setupProductionHandlers();
    
    // Обработчик отправки формы для предотвращения ошибок невидимых полей
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            // Перед отправкой формы убедимся, что все скрытые поля не требуют заполнения
            document.querySelectorAll('.operation-fields:not([style*="display: block"]) input, .operation-fields:not([style*="display: block"]) select').forEach(input => {
                // Временно снимаем требование обязательности для скрытых полей
                if (input.required) {
                    input.required = false;
                }
            });
        });
    }

    // Функция для переключения отображения полей специфичных для типа транспорта
    function toggleTransportFields(transportEntry, transportType) {
        // Скрываем все специфичные поля
        transportEntry.querySelectorAll('.wagon-specific-field, .truck-specific-field').forEach(field => {
            field.style.display = 'none';
        });
        
        // Показываем только поля для выбранного типа транспорта
        if (transportType === 'wagon') {
            transportEntry.querySelectorAll('.wagon-specific-field').forEach(field => {
                field.style.display = 'block';
            });
            
            // Делаем поля для вагона обязательными
            transportEntry.querySelectorAll('.wagon-specific-field select, .wagon-specific-field input').forEach(input => {
                if (input.hasAttribute('data-was-required')) {
                    input.required = true;
                }
            });
            
            // Снимаем обязательность с полей грузовика
            transportEntry.querySelectorAll('.truck-specific-field select, .truck-specific-field input').forEach(input => {
                if (input.required) {
                    input.setAttribute('data-was-required', 'true');
                    input.required = false;
                }
            });
        } else if (transportType === 'truck') {
            transportEntry.querySelectorAll('.truck-specific-field').forEach(field => {
                field.style.display = 'block';
            });
            
            // Делаем поля для грузовика обязательными
            transportEntry.querySelectorAll('.truck-specific-field select, .truck-specific-field input').forEach(input => {
                if (input.hasAttribute('data-was-required')) {
                    input.required = true;
                }
            });
            
            // Снимаем обязательность с полей вагона
            transportEntry.querySelectorAll('.wagon-specific-field select, .wagon-specific-field input').forEach(input => {
                if (input.required) {
                    input.setAttribute('data-was-required', 'true');
                    input.required = false;
                }
            });
        }
    }
});
</script>
{% endblock %}
{% endblock %}
