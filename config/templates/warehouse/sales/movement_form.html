{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>{{ title }}</h1>
        {% if movement %}
        <a href="{% url 'warehouse:sales_movement_detail' movement.id %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Отмена
        </a>
        {% else %}
        <a href="{% url 'warehouse:sales_department_dashboard' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Назад
        </a>
        {% endif %}
    </div>

    {% if messages %}
    <div class="messages mb-4">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {% if form.errors %}
    <div class="alert alert-danger mb-4">
        <h5 class="alert-heading"><i class="bi bi-exclamation-triangle-fill"></i> Ошибка при заполнении формы</h5>
        <ul class="mb-0">
            {% for field, errors in form.errors.items %}
                {% for error in errors %}
                    <li>{{ error }}</li>
                {% endfor %}
            {% endfor %}
            {% if form.non_field_errors %}
                {% for error in form.non_field_errors %}
                    <li>{{ error }}</li>
                {% endfor %}
            {% endif %}
        </ul>
    </div>
    {% endif %}

    <div class="card shadow-sm">
        <div class="card-header bg-light">
            <h5 class="mb-0">Информация об операции</h5>
        </div>
        <div class="card-body">
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                
                <div class="row g-3">
                    <!-- Тип движения -->
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="id_movement_type" class="form-label">Тип операции:</label>
                            <select name="movement_type" id="id_movement_type" class="form-select" required>
                                <option value="">-- Выберите тип операции --</option>
                                {% for value, text in form.fields.movement_type.choices %}
                                <option value="{{ value }}" {% if form.movement_type.value == value %}selected{% endif %}>{{ text }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <!-- Дата -->
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="id_date" class="form-label">Дата:</label>
                            <input type="date" name="date" id="id_date" class="form-control" value="{{ form.date.value|date:'Y-m-d'|default:'' }}" required>
                        </div>
                    </div>
                    
                    <!-- Продукт -->
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="id_product" class="form-label">Продукт:</label>
                            <select name="product" id="id_product" class="form-select" required>
                                <option value="">-- Выберите продукт --</option>
                                {% for product in form.fields.product.queryset %}
                                <option value="{{ product.id }}" {% if form.product.value == product.id %}selected{% endif %}>{{ product.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <!-- Номер документа -->
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="id_document_number" class="form-label">Номер документа:</label>
                            <input type="text" name="document_number" id="id_document_number" class="form-control" value="{{ form.document_number.value|default:'' }}">
                        </div>
                    </div>

                    <!-- Ожидаемое количество -->
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="id_expected_quantity" class="form-label">Ожидаемое количество (тонн):</label>
                            <input type="number" name="expected_quantity" id="id_expected_quantity" step="0.001" class="form-control" value="{{ form.expected_quantity.value|default:'' }}">
                        </div>
                    </div>
                    
                    <!-- Номер транспорта -->
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="id_transport_number" class="form-label">Номер транспорта:</label>
                            <input type="text" name="transport_number" id="id_transport_number" class="form-control" value="{{ form.transport_number.value|default:'' }}">
                        </div>
                    </div>
                    
                    <!-- Разделы, зависящие от типа операции -->
                    <!-- Приемка (in) -->
                    <div id="reception-fields" class="col-12 operation-fields">
                        <div class="card mb-3">
                            <div class="card-header bg-success bg-opacity-10">
                                <h5 class="mb-0">Данные о приемке</h5>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <!-- Поставщик -->
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="id_supplier" class="form-label">Поставщик:</label>
                                            <select name="supplier" id="id_supplier" class="form-select">
                                                <option value="">-- Выберите поставщика --</option>
                                                {% for supplier in form.fields.supplier.queryset %}
                                                <option value="{{ supplier.id }}" {% if form.supplier.value == supplier.id %}selected{% endif %}>{{ supplier.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <!-- Клиент -->
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="id_client_type" class="form-label">Тип клиента:</label>
                                            <select name="client_type" id="id_client_type" class="form-select">
                                                <option value="">-- Выберите тип клиента --</option>
                                                {% for value, text in form.fields.client_type.choices %}
                                                <option value="{{ value }}" {% if form.client_type.value == value %}selected{% endif %}>{{ text }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Транспортные средства -->
                        <div class="card mb-3">
                            <div class="card-header bg-success bg-opacity-10 d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Транспортные средства</h5>
                                <button type="button" class="btn btn-success btn-sm" id="add-reception-transport">
                                    <i class="bi bi-plus-circle"></i> Добавить транспорт
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="reception-transports-container">
                                    <!-- Шаблон для транспортного средства -->
                                    <div class="transport-entry card mb-3" data-index="0">
                                        <div class="card-header bg-light d-flex justify-content-between align-items-center py-2">
                                            <h6 class="mb-0">Транспорт #<span class="transport-number">1</span></h6>
                                            <button type="button" class="btn btn-danger btn-sm remove-transport" style="display:none">
                                                <i class="bi bi-x-circle"></i>
                                            </button>
                                        </div>
                                        <div class="card-body">
                                            <div class="row g-3">
                                                <!-- Тип транспорта -->
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label class="form-label">Тип транспорта:</label>
                                                        <select class="form-select transport-type" name="reception_transport_type_0" required>
                                                            <option value="">-- Выберите тип --</option>
                                                            <option value="truck">Грузовик</option>
                                                            <option value="wagon">Вагон</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                
                                                <!-- Номер транспорта -->
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label class="form-label">Номер транспорта:</label>
                                                        <input type="text" class="form-control transport-number-input" name="reception_transport_number_0" required>
                                                    </div>
                                                </div>
                                                
                                                <!-- Плотность -->
                                                <div class="col-md-4">
                                                    <div class="form-group">
                                                        <label class="form-label">Плотность (кг/м³):</label>
                                                        <input type="number" class="form-control density-input" name="reception_density_0" step="0.001" required>
                                                    </div>
                                                </div>
                                                
                                                <!-- Температура -->
                                                <div class="col-md-4">
                                                    <div class="form-group">
                                                        <label class="form-label">Температура (°C):</label>
                                                        <input type="number" class="form-control temperature-input" name="reception_temperature_0" step="0.1" value="20" required>
                                                    </div>
                                                </div>
                                                
                                                <!-- Объем (литры) / Высота (см) -->
                                                <div class="col-md-4 liter-field">
                                                    <div class="form-group">
                                                        <label class="form-label">Объем (литры):</label>
                                                        <input type="number" class="form-control liter-input" name="reception_liter_0" step="0.001" required>
                                                    </div>
                                                </div>
                                                <div class="col-md-4 height-field" style="display:none">
                                                    <div class="form-group">
                                                        <label class="form-label">Высота (см):</label>
                                                        <input type="number" class="form-control height-input" name="reception_height_0" step="0.1">
                                                    </div>
                                                </div>
                                                
                                                <!-- Расчетная масса -->
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label class="form-label">Расчетная масса (тонны):</label>
                                                        <input type="number" class="form-control quantity-input" name="reception_quantity_0" step="0.001" readonly>
                                                    </div>
                                                </div>
                                                
                                                <!-- Фото транспорта -->
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label class="form-label">Фото транспорта:</label>
                                                        <input type="file" class="form-control transport-photo" name="reception_transport_photo_0" accept="image/*">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Итоговая информация -->
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">Итоговая информация</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row g-3">
                                            <!-- Общее количество -->
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label class="form-label">Общее количество (тонны):</label>
                                                    <input type="number" id="reception-total-quantity" class="form-control" readonly>
                                                    <input type="hidden" name="reception_transports_json" id="reception-transports-json">
                                                </div>
                                            </div>
                                            
                                            <!-- Целевое хранилище -->
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label class="form-label">Целевое хранилище:</label>
                                                    <div class="row g-2">
                                                        <div class="col-4">
                                                            <div class="form-group">
                                                                <label for="id_target_warehouse" class="form-label">Склад:</label>
                                                                <select name="target_warehouse" id="id_target_warehouse" class="form-select">
                                                                    <option value="">-- Выберите склад --</option>
                                                                    {% for warehouse in form.fields.target_warehouse.queryset %}
                                                                    <option value="{{ warehouse.id }}" {% if form.target_warehouse.value == warehouse.id %}selected{% endif %}>{{ warehouse.name }}</option>
                                                                    {% endfor %}
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <div class="col-4">
                                                            <div class="form-group">
                                                                <label for="id_target_reservoir" class="form-label">Резервуар:</label>
                                                                <select name="target_reservoir" id="id_target_reservoir" class="form-select">
                                                                    <option value="">-- Выберите резервуар --</option>
                                                                    {% for reservoir in form.fields.target_reservoir.queryset %}
                                                                    <option value="{{ reservoir.id }}" {% if form.target_reservoir.value == reservoir.id %}selected{% endif %}>{{ reservoir.name }}</option>
                                                                    {% endfor %}
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <div class="col-4">
                                                            <div class="form-group">
                                                                <label for="id_target_wagon" class="form-label">Вагон:</label>
                                                                <select name="target_wagon" id="id_target_wagon" class="form-select">
                                                                    <option value="">-- Выберите вагон --</option>
                                                                    {% for wagon in form.fields.target_wagon.queryset %}
                                                                    <option value="{{ wagon.id }}" {% if form.target_wagon.value == wagon.id %}selected{% endif %}>{{ wagon.wagon_number }}</option>
                                                                    {% endfor %}
                                                                </select>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Продажа (out) -->
                    <div id="sales-fields" class="col-12 operation-fields">
                        <div class="card mb-3">
                            <div class="card-header bg-warning bg-opacity-10">
                                <h5 class="mb-0">Данные о продаже</h5>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <!-- Клиент -->
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="id_client" class="form-label">Клиент:</label>
                                            <select name="client" id="id_client" class="form-select" required>
                                                <option value="">-- Выберите клиента --</option>
                                                {% for client in form.fields.client.queryset %}
                                                <option value="{{ client.id }}" {% if form.client.value == client.id %}selected{% endif %}>{{ client.title }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <!-- Тип клиента -->
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="id_client_type" class="form-label">Тип клиента:</label>
                                            <select name="client_type" id="id_client_type_sale" class="form-select" required>
                                                <option value="">-- Выберите тип клиента --</option>
                                                {% for value, text in form.fields.client_type.choices %}
                                                <option value="{{ value }}" {% if form.client_type.value == value %}selected{% endif %}>{{ text }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Источник (откуда отгружаем) -->
                        <div class="card mb-3">
                            <div class="card-header bg-warning bg-opacity-10">
                                <h5 class="mb-0">Источник (откуда отгружаем)</h5>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="id_source_warehouse" class="form-label">Склад:</label>
                                            <select name="source_warehouse" id="id_source_warehouse" class="form-select">
                                                <option value="">-- Выберите склад --</option>
                                                {% for warehouse in form.fields.source_warehouse.queryset %}
                                                <option value="{{ warehouse.id }}" {% if form.source_warehouse.value == warehouse.id %}selected{% endif %}>{{ warehouse.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="id_source_reservoir" class="form-label">Резервуар:</label>
                                            <select name="source_reservoir" id="id_source_reservoir" class="form-select">
                                                <option value="">-- Выберите резервуар --</option>
                                                {% for reservoir in form.fields.source_reservoir.queryset %}
                                                <option value="{{ reservoir.id }}" {% if form.source_reservoir.value == reservoir.id %}selected{% endif %}>{{ reservoir.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="id_source_wagon" class="form-label">Вагон:</label>
                                            <select name="source_wagon" id="id_source_wagon" class="form-select">
                                                <option value="">-- Выберите вагон --</option>
                                                {% for wagon in form.fields.source_wagon.queryset %}
                                                <option value="{{ wagon.id }}" {% if form.source_wagon.value == wagon.id %}selected{% endif %}>{{ wagon.wagon_number }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Транспортные средства -->
                        <div class="card mb-3">
                            <div class="card-header bg-warning bg-opacity-10 d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Транспортные средства для отгрузки</h5>
                                <button type="button" class="btn btn-warning btn-sm" id="add-sales-transport">
                                    <i class="bi bi-plus-circle"></i> Добавить транспорт
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="sales-transports-container">
                                    <!-- Шаблон для транспортного средства -->
                                    <div class="sales-transport-entry card mb-3" data-index="0">
                                        <div class="card-header bg-light d-flex justify-content-between align-items-center py-2">
                                            <h6 class="mb-0">Транспорт #<span class="transport-number">1</span></h6>
                                            <button type="button" class="btn btn-danger btn-sm remove-sales-transport" style="display:none">
                                                <i class="bi bi-x-circle"></i>
                                            </button>
                                        </div>
                                        <div class="card-body">
                                            <div class="row g-3">
                                                <!-- Тип транспорта -->
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label class="form-label">Тип транспорта:</label>
                                                        <select class="form-select sales-transport-type" name="sales_transport_type_0" required>
                                                            <option value="">-- Выберите тип --</option>
                                                            <option value="truck">Грузовик</option>
                                                            <option value="wagon">Вагон</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                
                                                <!-- Номер транспорта -->
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label class="form-label">Номер транспорта:</label>
                                                        <input type="text" class="form-control sales-transport-number" name="sales_transport_number_0" required>
                                                    </div>
                                                </div>
                                                
                                                <!-- Ожидаемый вес -->
                                                <div class="col-md-4">
                                                    <div class="form-group">
                                                        <label class="form-label">Ожидаемый вес (тонны):</label>
                                                        <input type="number" class="form-control sales-expected-weight" name="sales_expected_weight_0" step="0.001" required>
                                                    </div>
                                                </div>
                                                
                                                <!-- Плотность -->
                                                <div class="col-md-4">
                                                    <div class="form-group">
                                                        <label class="form-label">Плотность (кг/м³):</label>
                                                        <input type="number" class="form-control sales-density" name="sales_density_0" step="0.001">
                                                    </div>
                                                </div>
                                                
                                                <!-- Температура -->
                                                <div class="col-md-4">
                                                    <div class="form-group">
                                                        <label class="form-label">Температура (°C):</label>
                                                        <input type="number" class="form-control sales-temperature" name="sales_temperature_0" step="0.1" value="20">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Итоговая информация -->
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">Итоговая информация</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row g-3">
                                            <!-- Общее количество -->
                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <label class="form-label">Общее количество (тонны):</label>
                                                    <input type="number" id="sales-total-quantity" class="form-control" readonly>
                                                    <input type="hidden" name="sales_transports_json" id="sales-transports-json">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Производство (production) -->
                    <div id="production-fields" class="col-12 operation-fields">
                        <div class="card mb-3">
                            <div class="card-header bg-info bg-opacity-10">
                                <h5 class="mb-0">Данные о производстве</h5>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <!-- Целевой продукт -->
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label">Целевой продукт:</label>
                                            <select name="target_product" id="id_target_product" class="form-select">
                                                <option value="">-- Выберите целевой продукт --</option>
                                                {% for product in form.fields.product.queryset %}
                                                <option value="{{ product.id }}" {% if form.product.value == product.id %}selected{% endif %}>{{ product.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <!-- Ожидаемое количество продукта -->
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label">Ожидаемое количество продукта (тонны):</label>
                                            <input type="number" class="form-control" name="production_expected_quantity" id="id_production_expected_quantity" step="0.001" required>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Источники сырья -->
                        <div class="card mb-3">
                            <div class="card-header bg-info bg-opacity-10 d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Источники сырья</h5>
                                <button type="button" class="btn btn-info btn-sm" id="add-raw-material">
                                    <i class="bi bi-plus-circle"></i> Добавить источник сырья
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="raw-materials-container">
                                    <!-- Шаблон для источника сырья -->
                                    <div class="raw-material-entry card mb-3" data-index="0">
                                        <div class="card-header bg-light d-flex justify-content-between align-items-center py-2">
                                            <h6 class="mb-0">Источник сырья #<span class="material-number">1</span></h6>
                                            <button type="button" class="btn btn-danger btn-sm remove-raw-material" style="display:none">
                                                <i class="bi bi-x-circle"></i>
                                            </button>
                                        </div>
                                        <div class="card-body">
                                            <div class="row g-3">
                                                <!-- Тип сырья / Компонент -->
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label class="form-label">Компонент:</label>
                                                        <select class="form-select raw-material-product" name="raw_material_product_0" required>
                                                            <option value="">-- Выберите компонент --</option>
                                                            {% for product in form.fields.product.queryset %}
                                                            <option value="{{ product.id }}">{{ product.name }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                </div>
                                                
                                                <!-- Процентное содержание -->
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label class="form-label">Процентное содержание (%):</label>
                                                        <input type="number" class="form-control raw-material-percentage" name="raw_material_percentage_0" step="0.01" min="0" max="100" required>
                                                    </div>
                                                </div>
                                                
                                                <!-- Источник хранения -->
                                                <div class="col-md-12">
                                                    <div class="form-group">
                                                        <label class="form-label">Источник хранения:</label>
                                                        <div class="row g-2">
                                                            <div class="col-md-4">
                                                                <select class="form-select raw-material-source-type" name="raw_material_source_type_0" required>
                                                                    <option value="">-- Выберите тип --</option>
                                                                    <option value="reservoir">Резервуар</option>
                                                                    <option value="wagon">Вагон</option>
                                                                    <option value="warehouse">Склад</option>
                                                                </select>
                                                            </div>
                                                            <div class="col-md-8">
                                                                <div class="raw-material-source-reservoir" style="display:none">
                                                                    <select class="form-select" name="raw_material_source_reservoir_0">
                                                                        <option value="">-- Выберите резервуар --</option>
                                                                        {% for reservoir in form.fields.source_reservoir.queryset %}
                                                                        <option value="{{ reservoir.id }}">{{ reservoir.name }}</option>
                                                                        {% endfor %}
                                                                    </select>
                                                                </div>
                                                                <div class="raw-material-source-wagon" style="display:none">
                                                                    <select class="form-select" name="raw_material_source_wagon_0">
                                                                        <option value="">-- Выберите вагон --</option>
                                                                        {% for wagon in form.fields.source_wagon.queryset %}
                                                                        <option value="{{ wagon.id }}">{{ wagon.wagon_number }}</option>
                                                                        {% endfor %}
                                                                    </select>
                                                                </div>
                                                                <div class="raw-material-source-warehouse" style="display:none">
                                                                    <select class="form-select" name="raw_material_source_warehouse_0">
                                                                        <option value="">-- Выберите склад --</option>
                                                                        {% for warehouse in form.fields.source_warehouse.queryset %}
                                                                        <option value="{{ warehouse.id }}">{{ warehouse.name }}</option>
                                                                        {% endfor %}
                                                                    </select>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Расчетное количество -->
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label class="form-label">Расчетное количество (тонны):</label>
                                                        <input type="number" class="form-control raw-material-quantity" name="raw_material_quantity_0" step="0.001" readonly>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Итоговая информация -->
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">Итоговая информация</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row g-3">
                                            <!-- Суммарное процентное содержание -->
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label class="form-label">Суммарное процентное содержание (%):</label>
                                                    <div class="input-group">
                                                        <input type="number" id="total-percentage" class="form-control" readonly>
                                                        <span class="input-group-text">%</span>
                                                    </div>
                                                    <div class="form-text text-danger" id="percentage-warning" style="display:none">
                                                        Сумма процентов должна быть равна 100%
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Общее количество сырья -->
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label class="form-label">Общее количество сырья (тонны):</label>
                                                    <input type="number" id="raw-materials-total-quantity" class="form-control" readonly>
                                                    <input type="hidden" name="raw_materials_json" id="raw-materials-json">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Целевое хранилище -->
                        <div class="card mb-3">
                            <div class="card-header bg-info bg-opacity-10">
                                <h5 class="mb-0">Целевое хранилище</h5>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="id_target_warehouse_production" class="form-label">Склад:</label>
                                            <select name="target_warehouse" id="id_target_warehouse_production" class="form-select">
                                                <option value="">-- Выберите склад --</option>
                                                {% for warehouse in form.fields.target_warehouse.queryset %}
                                                <option value="{{ warehouse.id }}" {% if form.target_warehouse.value == warehouse.id %}selected{% endif %}>{{ warehouse.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="id_target_reservoir_production" class="form-label">Резервуар:</label>
                                            <select name="target_reservoir" id="id_target_reservoir_production" class="form-select">
                                                <option value="">-- Выберите резервуар --</option>
                                                {% for reservoir in form.fields.target_reservoir.queryset %}
                                                <option value="{{ reservoir.id }}" {% if form.target_reservoir.value == reservoir.id %}selected{% endif %}>{{ reservoir.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="id_target_wagon_production" class="form-label">Вагон:</label>
                                            <select name="target_wagon" id="id_target_wagon_production" class="form-select">
                                                <option value="">-- Выберите вагон --</option>
                                                {% for wagon in form.fields.target_wagon.queryset %}
                                                <option value="{{ wagon.id }}" {% if form.target_wagon.value == wagon.id %}selected{% endif %}>{{ wagon.wagon_number }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Перемещение (transfer) -->
                    <div id="transfer-fields" class="col-12 operation-fields">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header bg-info bg-opacity-10">
                                        <h5 class="mb-0">Источник (откуда перемещаем)</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row g-3">
                                            <div class="col-12">
                                                <div class="form-group">
                                                    <label for="id_source_reservoir" class="form-label">Резервуар:</label>
                                                    <select name="source_reservoir" id="id_source_reservoir_transfer" class="form-select">
                                                        <option value="">-- Выберите резервуар --</option>
                                                        {% for reservoir in form.fields.source_reservoir.queryset %}
                                                        <option value="{{ reservoir.id }}" {% if form.source_reservoir.value == reservoir.id %}selected{% endif %}>{{ reservoir.name }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-12">
                                                <div class="form-group">
                                                    <label for="id_source_wagon" class="form-label">Вагон:</label>
                                                    <select name="source_wagon" id="id_source_wagon_transfer" class="form-select">
                                                        <option value="">-- Выберите вагон --</option>
                                                        {% for wagon in form.fields.source_wagon.queryset %}
                                                        <option value="{{ wagon.id }}" {% if form.source_wagon.value == wagon.id %}selected{% endif %}>{{ wagon.wagon_number }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header bg-info bg-opacity-10">
                                        <h5 class="mb-0">Назначение (куда перемещаем)</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row g-3">
                                            <div class="col-12">
                                                <div class="form-group">
                                                    <label for="id_target_reservoir" class="form-label">Резервуар:</label>
                                                    <select name="target_reservoir" id="id_target_reservoir_transfer" class="form-select">
                                                        <option value="">-- Выберите резервуар --</option>
                                                        {% for reservoir in form.fields.target_reservoir.queryset %}
                                                        <option value="{{ reservoir.id }}" {% if form.target_reservoir.value == reservoir.id %}selected{% endif %}>{{ reservoir.name }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-12">
                                                <div class="form-group">
                                                    <label for="id_target_wagon" class="form-label">Вагон:</label>
                                                    <select name="target_wagon" id="id_target_wagon_transfer" class="form-select">
                                                        <option value="">-- Выберите вагон --</option>
                                                        {% for wagon in form.fields.target_wagon.queryset %}
                                                        <option value="{{ wagon.id }}" {% if form.target_wagon.value == wagon.id %}selected{% endif %}>{{ wagon.wagon_number }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Примечание -->
                    <div class="col-12">
                        <div class="form-group">
                            <label for="id_note" class="form-label">Примечание:</label>
                            <textarea name="note" id="id_note" class="form-control" rows="3">{{ form.note.value|default:'' }}</textarea>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4 d-flex justify-content-end">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle"></i> 
                        {% if movement %}Сохранить изменения{% else %}Создать операцию{% endif %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Функция показа/скрытия полей в зависимости от типа операции
        function toggleOperationFields() {
            const movementType = document.getElementById('id_movement_type').value;
            
            // Скрываем все поля
            document.querySelectorAll('.operation-fields').forEach(function(field) {
                field.style.display = 'none';
            });
            
            // Показываем поля соответствующие выбранному типу операции
            if (movementType === 'in') {
                document.getElementById('reception-fields').style.display = 'block';
            } else if (movementType === 'out') {
                document.getElementById('sales-fields').style.display = 'block';
            } else if (movementType === 'production') {
                document.getElementById('production-fields').style.display = 'block';
            } else if (movementType === 'transfer') {
                document.getElementById('transfer-fields').style.display = 'block';
            }
        }
        
        // Слушаем изменения типа операции
        document.getElementById('id_movement_type').addEventListener('change', toggleOperationFields);
        
        // Инициализация при загрузке страницы
        toggleOperationFields();

        // ==========================================================
        // Функциональность для работы с множественными транспортами в ПРИЕМКЕ
        // ==========================================================
        
        let receptionTransportCounter = 1;
        
        // Добавление нового транспорта
        const addReceptionTransportBtn = document.getElementById('add-reception-transport');
        if (addReceptionTransportBtn) {
            addReceptionTransportBtn.addEventListener('click', function() {
                const container = document.getElementById('reception-transports-container');
                const transportEntries = container.querySelectorAll('.transport-entry');
                const lastEntry = transportEntries[transportEntries.length - 1];
                const newEntry = lastEntry.cloneNode(true);
                
                // Обновляем индекс и заголовок
                receptionTransportCounter++;
                newEntry.setAttribute('data-index', receptionTransportCounter - 1);
                newEntry.querySelector('.transport-number').textContent = receptionTransportCounter;
                
                // Очищаем значения полей
                newEntry.querySelectorAll('input').forEach(input => {
                    if (input.type === 'number') {
                        if (input.classList.contains('temperature-input')) {
                            input.value = '20'; // Стандартная температура
                        } else {
                            input.value = '';
                        }
                    } else if (input.type === 'file') {
                        input.value = '';
                    } else {
                        input.value = '';
                    }
                    
                    // Обновляем имена полей
                    const name = input.getAttribute('name');
                    if (name) {
                        const baseName = name.split('_').slice(0, -1).join('_');
                        input.setAttribute('name', `${baseName}_${receptionTransportCounter - 1}`);
                    }
                });
                
                // Обновляем имена селекторов
                newEntry.querySelectorAll('select').forEach(select => {
                    const name = select.getAttribute('name');
                    if (name) {
                        const baseName = name.split('_').slice(0, -1).join('_');
                        select.setAttribute('name', `${baseName}_${receptionTransportCounter - 1}`);
                        select.value = '';
                    }
                });
                
                // Показываем кнопку удаления
                newEntry.querySelector('.remove-transport').style.display = 'block';
                
                // Добавляем новый блок в контейнер
                container.appendChild(newEntry);
                
                // Обновляем обработчики событий
                setupReceptionEventHandlers();
                updateReceptionTotals();
            });
        }
        
        // Настройка обработчиков событий для приемки
        function setupReceptionEventHandlers() {
            // Обработчики для кнопок удаления
            document.querySelectorAll('.remove-transport').forEach(button => {
                button.addEventListener('click', function() {
                    const entry = this.closest('.transport-entry');
                    entry.remove();
                    updateReceptionTransportNumbers();
                    updateReceptionTotals();
                });
            });
            
            // Обработчики для типа транспорта
            document.querySelectorAll('.transport-type').forEach(select => {
                select.addEventListener('change', function() {
                    const entry = this.closest('.transport-entry');
                    const literField = entry.querySelector('.liter-field');
                    const heightField = entry.querySelector('.height-field');
                    
                    if (this.value === 'truck') {
                        literField.style.display = 'block';
                        heightField.style.display = 'none';
                    } else if (this.value === 'wagon') {
                        literField.style.display = 'none';
                        heightField.style.display = 'block';
                    }
                });
            });
            
            // Обработчики для полей ввода плотности, температуры и объема
            document.querySelectorAll('.density-input, .temperature-input, .liter-input, .height-input').forEach(input => {
                input.addEventListener('input', function() {
                    calculateReceptionQuantity(this.closest('.transport-entry'));
                    updateReceptionTotals();
                });
            });
        }
        
        // Обновление номеров транспорта в приемке
        function updateReceptionTransportNumbers() {
            let counter = 1;
            document.querySelectorAll('.transport-entry').forEach(entry => {
                entry.querySelector('.transport-number').textContent = counter++;
            });
            receptionTransportCounter = counter - 1;
        }
        
        // Расчет массы по плотности, температуре и объему для приемки
        function calculateReceptionQuantity(transportEntry) {
            const density = parseFloat(transportEntry.querySelector('.density-input').value) || 0;
            const temperature = parseFloat(transportEntry.querySelector('.temperature-input').value) || 20;
            const transportType = transportEntry.querySelector('.transport-type').value;
            let quantity = 0;
            
            if (transportType === 'truck') {
                const liter = parseFloat(transportEntry.querySelector('.liter-input').value) || 0;
                // Формула для расчета массы в тоннах: Плотность * Объем / 1000 = масса в тоннах
                if (density > 0 && liter > 0) {
                    quantity = (density * liter) / 1000;
                }
            } else if (transportType === 'wagon') {
                const height = parseFloat(transportEntry.querySelector('.height-input').value) || 0;
                // Здесь должна быть формула расчета для вагона по высоте
                // Это зависит от типа вагона, его объема и т.д.
                // Пример: quantity = (height * коэффициент_вагона * density) / 1000;
                if (density > 0 && height > 0) {
                    // Упрощенная формула для примера
                    quantity = (height * 100 * density) / 1000; // предполагаем, что 1 см высоты = 100 литров
                }
            }
            
            transportEntry.querySelector('.quantity-input').value = quantity.toFixed(3);
        }
        
        // Обновление итоговых значений для приемки
        function updateReceptionTotals() {
            let totalQuantity = 0;
            const transportsData = [];
            
            document.querySelectorAll('.transport-entry').forEach(entry => {
                const quantity = parseFloat(entry.querySelector('.quantity-input').value) || 0;
                const transportType = entry.querySelector('.transport-type').value;
                const transportNumber = entry.querySelector('.transport-number-input').value;
                const density = parseFloat(entry.querySelector('.density-input').value) || 0;
                const temperature = parseFloat(entry.querySelector('.temperature-input').value) || 20;
                
                totalQuantity += quantity;
                
                if (transportType && transportNumber && quantity > 0) {
                    const transportData = {
                        transport_type: transportType,
                        transport_number: transportNumber,
                        density: density,
                        temperature: temperature,
                        quantity: quantity
                    };
                    
                    if (transportType === 'truck') {
                        transportData.liter = parseFloat(entry.querySelector('.liter-input').value) || 0;
                    } else if (transportType === 'wagon') {
                        transportData.height = parseFloat(entry.querySelector('.height-input').value) || 0;
                    }
                    
                    transportsData.push(transportData);
                }
            });
            
            // Обновляем общее количество
            const totalQuantityElement = document.getElementById('reception-total-quantity');
            if (totalQuantityElement) {
                totalQuantityElement.value = totalQuantity.toFixed(3);
            }
            
            // Обновляем скрытое поле с JSON данными о транспорте
            const transportsJsonElement = document.getElementById('reception-transports-json');
            if (transportsJsonElement) {
                transportsJsonElement.value = JSON.stringify(transportsData);
            }
            
            // Копируем значение в основное поле expected_quantity
            const expectedQuantityElement = document.getElementById('id_expected_quantity');
            if (expectedQuantityElement) {
                expectedQuantityElement.value = totalQuantity.toFixed(3);
            }
        }

        // ==========================================================
        // Функциональность для работы с множественными транспортами в ПРОДАЖЕ
        // ==========================================================
        
        let salesTransportCounter = 1;
        
        // Добавление нового транспорта для продажи
        const addSalesTransportBtn = document.getElementById('add-sales-transport');
        if (addSalesTransportBtn) {
            addSalesTransportBtn.addEventListener('click', function() {
                const container = document.getElementById('sales-transports-container');
                const transportEntries = container.querySelectorAll('.sales-transport-entry');
                const lastEntry = transportEntries[transportEntries.length - 1];
                const newEntry = lastEntry.cloneNode(true);
                
                // Обновляем индекс и заголовок
                salesTransportCounter++;
                newEntry.setAttribute('data-index', salesTransportCounter - 1);
                newEntry.querySelector('.transport-number').textContent = salesTransportCounter;
                
                // Очищаем значения полей
                newEntry.querySelectorAll('input').forEach(input => {
                    if (input.type === 'number') {
                        if (input.classList.contains('sales-temperature')) {
                            input.value = '20'; // Стандартная температура
                        } else {
                            input.value = '';
                        }
                    } else {
                        input.value = '';
                    }
                    
                    // Обновляем имена полей
                    const name = input.getAttribute('name');
                    if (name) {
                        const baseName = name.split('_').slice(0, -1).join('_');
                        input.setAttribute('name', `${baseName}_${salesTransportCounter - 1}`);
                    }
                });
                
                // Обновляем имена селекторов
                newEntry.querySelectorAll('select').forEach(select => {
                    const name = select.getAttribute('name');
                    if (name) {
                        const baseName = name.split('_').slice(0, -1).join('_');
                        select.setAttribute('name', `${baseName}_${salesTransportCounter - 1}`);
                        select.value = '';
                    }
                });
                
                // Показываем кнопку удаления
                newEntry.querySelector('.remove-sales-transport').style.display = 'block';
                
                // Добавляем новый блок в контейнер
                container.appendChild(newEntry);
                
                // Обновляем обработчики событий
                setupSalesEventHandlers();
                updateSalesTotals();
            });
        }
        
        // Настройка обработчиков событий для продажи
        function setupSalesEventHandlers() {
            // Обработчики для кнопок удаления
            document.querySelectorAll('.remove-sales-transport').forEach(button => {
                button.addEventListener('click', function() {
                    const entry = this.closest('.sales-transport-entry');
                    entry.remove();
                    updateSalesTransportNumbers();
                    updateSalesTotals();
                });
            });
            
            // Обработчики для ожидаемого веса
            document.querySelectorAll('.sales-expected-weight').forEach(input => {
                input.addEventListener('input', updateSalesTotals);
            });
        }
        
        // Обновление номеров транспорта в продаже
        function updateSalesTransportNumbers() {
            let counter = 1;
            document.querySelectorAll('.sales-transport-entry').forEach(entry => {
                entry.querySelector('.transport-number').textContent = counter++;
            });
            salesTransportCounter = counter - 1;
        }
        
        // Обновление итоговых значений для продажи
        function updateSalesTotals() {
            let totalQuantity = 0;
            const transportsData = [];
            
            document.querySelectorAll('.sales-transport-entry').forEach(entry => {
                const expectedWeight = parseFloat(entry.querySelector('.sales-expected-weight').value) || 0;
                const transportType = entry.querySelector('.sales-transport-type').value;
                const transportNumber = entry.querySelector('.sales-transport-number').value;
                const density = parseFloat(entry.querySelector('.sales-density').value) || 0;
                const temperature = parseFloat(entry.querySelector('.sales-temperature').value) || 20;
                
                totalQuantity += expectedWeight;
                
                if (transportType && transportNumber && expectedWeight > 0) {
                    const transportData = {
                        transport_type: transportType,
                        transport_number: transportNumber,
                        expected_weight: expectedWeight,
                        density: density,
                        temperature: temperature
                    };
                    
                    transportsData.push(transportData);
                }
            });
            
            // Обновляем общее количество
            const totalQuantityElement = document.getElementById('sales-total-quantity');
            if (totalQuantityElement) {
                totalQuantityElement.value = totalQuantity.toFixed(3);
            }
            
            // Обновляем скрытое поле с JSON данными о транспорте
            const transportsJsonElement = document.getElementById('sales-transports-json');
            if (transportsJsonElement) {
                transportsJsonElement.value = JSON.stringify(transportsData);
            }
            
            // Копируем значение в основное поле expected_quantity
            const expectedQuantityElement = document.getElementById('id_expected_quantity');
            if (expectedQuantityElement) {
                expectedQuantityElement.value = totalQuantity.toFixed(3);
            }
        }

        // ==========================================================
        // Функциональность для работы с множественными источниками сырья в ПРОИЗВОДСТВЕ
        // ==========================================================
        
        let rawMaterialCounter = 1;
        
        // Добавление нового источника сырья
        const addRawMaterialBtn = document.getElementById('add-raw-material');
        if (addRawMaterialBtn) {
            addRawMaterialBtn.addEventListener('click', function() {
                const container = document.getElementById('raw-materials-container');
                const materialEntries = container.querySelectorAll('.raw-material-entry');
                const lastEntry = materialEntries[materialEntries.length - 1];
                const newEntry = lastEntry.cloneNode(true);
                
                // Обновляем индекс и заголовок
                rawMaterialCounter++;
                newEntry.setAttribute('data-index', rawMaterialCounter - 1);
                newEntry.querySelector('.material-number').textContent = rawMaterialCounter;
                
                // Очищаем значения полей
                newEntry.querySelectorAll('input, select').forEach(input => {
                    if (input.type === 'number' || input.type === 'text') {
                        input.value = '';
                    } else if (input.tagName === 'SELECT') {
                        input.selectedIndex = 0;
                    }
                    
                    // Обновляем имена полей
                    const name = input.getAttribute('name');
                    if (name) {
                        const baseName = name.split('_').slice(0, -1).join('_');
                        input.setAttribute('name', `${baseName}_${rawMaterialCounter - 1}`);
                    }
                });
                
                // Скрываем все селекторы источников
                newEntry.querySelector('.raw-material-source-reservoir').style.display = 'none';
                newEntry.querySelector('.raw-material-source-wagon').style.display = 'none';
                newEntry.querySelector('.raw-material-source-warehouse').style.display = 'none';
                
                // Показываем кнопку удаления
                newEntry.querySelector('.remove-raw-material').style.display = 'block';
                
                // Добавляем новый блок в контейнер
                container.appendChild(newEntry);
                
                // Обновляем обработчики событий
                setupProductionEventHandlers();
                updateProductionTotals();
            });
        }
        
        // Настройка обработчиков событий для производства
        function setupProductionEventHandlers() {
            // Обработчики для кнопок удаления
            document.querySelectorAll('.remove-raw-material').forEach(button => {
                button.addEventListener('click', function() {
                    const entry = this.closest('.raw-material-entry');
                    entry.remove();
                    updateRawMaterialNumbers();
                    updateProductionTotals();
                });
            });
            
            // Обработчики для типа источника сырья
            document.querySelectorAll('.raw-material-source-type').forEach(select => {
                select.addEventListener('change', function() {
                    const entry = this.closest('.raw-material-entry');
                    const reservoirField = entry.querySelector('.raw-material-source-reservoir');
                    const wagonField = entry.querySelector('.raw-material-source-wagon');
                    const warehouseField = entry.querySelector('.raw-material-source-warehouse');
                    
                    // Скрываем все
                    reservoirField.style.display = 'none';
                    wagonField.style.display = 'none';
                    warehouseField.style.display = 'none';
                    
                    // Показываем нужный селектор
                    if (this.value === 'reservoir') {
                        reservoirField.style.display = 'block';
                    } else if (this.value === 'wagon') {
                        wagonField.style.display = 'block';
                    } else if (this.value === 'warehouse') {
                        warehouseField.style.display = 'block';
                    }
                });
            });
            
            // Обработчики для процентного содержания и ожидаемого количества продукта
            document.querySelectorAll('.raw-material-percentage').forEach(input => {
                input.addEventListener('input', updateProductionTotals);
            });
            
            // Обработчик изменения ожидаемого количества продукта
            const productionExpectedQuantity = document.getElementById('id_production_expected_quantity');
            if (productionExpectedQuantity) {
                productionExpectedQuantity.addEventListener('input', updateProductionTotals);
            }
        }
        
        // Обновление номеров источников сырья
        function updateRawMaterialNumbers() {
            let counter = 1;
            document.querySelectorAll('.raw-material-entry').forEach(entry => {
                entry.querySelector('.material-number').textContent = counter++;
            });
            rawMaterialCounter = counter - 1;
        }
        
        // Обновление итоговых значений для производства
        function updateProductionTotals() {
            let totalPercentage = 0;
            let totalQuantity = 0;
            const rawMaterialsData = [];
            const expectedQuantity = parseFloat(document.getElementById('id_production_expected_quantity').value) || 0;
            
            document.querySelectorAll('.raw-material-entry').forEach(entry => {
                const percentage = parseFloat(entry.querySelector('.raw-material-percentage').value) || 0;
                const productId = entry.querySelector('.raw-material-product').value;
                const sourceType = entry.querySelector('.raw-material-source-type').value;
                let sourceId = null;
                
                totalPercentage += percentage;
                
                // Рассчитываем количество компонента на основе процентного содержания
                const componentQuantity = (percentage / 100) * expectedQuantity;
                entry.querySelector('.raw-material-quantity').value = componentQuantity.toFixed(3);
                
                totalQuantity += componentQuantity;
                
                // Определяем ID выбранного источника
                if (sourceType === 'reservoir') {
                    sourceId = entry.querySelector('.raw-material-source-reservoir select').value;
                } else if (sourceType === 'wagon') {
                    sourceId = entry.querySelector('.raw-material-source-wagon select').value;
                } else if (sourceType === 'warehouse') {
                    sourceId = entry.querySelector('.raw-material-source-warehouse select').value;
                }
                
                if (productId && sourceType && sourceId && percentage > 0) {
                    const materialData = {
                        product_id: productId,
                        source_type: sourceType,
                        source_id: sourceId,
                        percentage: percentage,
                        quantity: componentQuantity
                    };
                    
                    rawMaterialsData.push(materialData);
                }
            });
            
            // Обновляем суммарное процентное содержание
            const totalPercentageElement = document.getElementById('total-percentage');
            if (totalPercentageElement) {
                totalPercentageElement.value = totalPercentage.toFixed(2);
                
                // Проверяем сумму процентов
                const percentageWarning = document.getElementById('percentage-warning');
                if (percentageWarning) {
                    if (Math.abs(totalPercentage - 100) > 0.01) {
                        percentageWarning.style.display = 'block';
                    } else {
                        percentageWarning.style.display = 'none';
                    }
                }
            }
            
            // Обновляем общее количество сырья
            const totalQuantityElement = document.getElementById('raw-materials-total-quantity');
            if (totalQuantityElement) {
                totalQuantityElement.value = totalQuantity.toFixed(3);
            }
            
            // Обновляем скрытое поле с JSON данными об источниках сырья
            const rawMaterialsJsonElement = document.getElementById('raw-materials-json');
            if (rawMaterialsJsonElement) {
                rawMaterialsJsonElement.value = JSON.stringify(rawMaterialsData);
            }
            
            // Копируем значение в основное поле expected_quantity
            const expectedQuantityElement = document.getElementById('id_expected_quantity');
            if (expectedQuantityElement) {
                expectedQuantityElement.value = expectedQuantity.toFixed(3);
            }
        }
        
        // Инициализация обработчиков событий
        setupReceptionEventHandlers();
        setupSalesEventHandlers();
        setupProductionEventHandlers();
        
        // Инициализация итоговых значений
        updateReceptionTotals();
        updateSalesTotals();
        updateProductionTotals();
    });
</script>
{% endblock %}
{% endblock %} 