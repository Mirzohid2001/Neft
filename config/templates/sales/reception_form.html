{% extends 'base.html' %}
{% load static %}

{% block title %}Приемка товара{% endblock %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    :root {
        --primary: #6366f1;
        --primary-dark: #4338ca;
        --secondary: #10b981;
        --secondary-dark: #059669;
        --info: #06b6d4;
        --info-dark: #0e7490;
        --warning: #f59e0b;
        --warning-dark: #d97706;
        --danger: #ef4444;
        --danger-dark: #dc2626;
        --dark: #1e293b;
        --light: #f8fafc;
        --card-bg: rgba(255, 255, 255, 0.95);
        --card-border: rgba(255, 255, 255, 0.3);
        --card-shadow: rgba(17, 12, 46, 0.15);
    }
    
    body {
        background: #0f172a;
        color: var(--light);
        font-family: 'Poppins', sans-serif;
    }
    
    /* Улучшенный градиентный фон */
    .glass-bg {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
    }
    
    .glass-bg::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle at 25% 25%, rgba(99, 102, 241, 0.15), transparent),
                    radial-gradient(circle at 75% 75%, rgba(16, 185, 129, 0.15), transparent);
        animation: rotate 20s linear infinite;
    }
    
    @keyframes rotate {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* Декоративные плавающие иконки */
    .floating-icons {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: -1;
        overflow: hidden;
    }
    
    .floating-icon {
        position: absolute;
        opacity: 0.05;
        font-size: 2rem;
        animation: float 20s linear infinite;
    }
    
    @keyframes float {
        0% { transform: translate(0, 0) rotate(0deg); }
        25% { transform: translate(100px, 50px) rotate(90deg); }
        50% { transform: translate(200px, 0) rotate(180deg); }
        75% { transform: translate(100px, -50px) rotate(270deg); }
        100% { transform: translate(0, 0) rotate(360deg); }
    }
    
    /* Улучшенная форма */
    .page-header {
        position: relative;
        margin-bottom: 2.5rem;
        padding-bottom: 1rem;
        text-align: center;
    }
    
    .page-header h1 {
        font-weight: 700;
        background: linear-gradient(90deg, var(--warning), var(--warning-dark));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        position: relative;
        z-index: 1;
        margin-bottom: 0;
        font-size: 2.5rem;
    }
    
    .breadcrumb-container {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(5px);
        border-radius: 50px;
        padding: 0.5rem 1.5rem;
        margin-bottom: 2rem;
        display: inline-flex;
        align-items: center;
    }
    
    .breadcrumb {
        margin-bottom: 0;
        background: transparent;
        padding: 0;
    }
    
    .breadcrumb-item {
        display: flex;
        align-items: center;
        color: rgba(255, 255, 255, 0.7);
    }
    
    .breadcrumb-item a {
        color: rgba(255, 255, 255, 0.9);
        text-decoration: none;
        transition: all 0.3s ease;
    }
    
    .breadcrumb-item a:hover {
        color: var(--warning);
    }
    
    .breadcrumb-item+.breadcrumb-item::before {
        color: rgba(255, 255, 255, 0.5);
    }
    
    .reception-form {
        background: rgba(255, 255, 255, 0.03);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 0;
        transition: all 0.3s ease;
        margin-bottom: 2rem;
    }
    
    .form-section {
        background: rgba(30, 30, 60, 0.7);
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        margin-bottom: 2rem;
        color: var(--light);
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .form-section:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        border-color: rgba(255, 255, 255, 0.15);
    }
    
    .section-header {
        padding: 1.5rem 2rem;
        background: linear-gradient(to right, rgba(245, 158, 11, 0.2), rgba(245, 158, 11, 0.05));
        border-bottom: 1px solid rgba(245, 158, 11, 0.2);
        display: flex;
        align-items: center;
    }
    
    .section-header h3 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        color: var(--light);
    }
    
    .section-header h3 i {
        margin-right: 10px;
        font-size: 1.4rem;
        background: linear-gradient(135deg, var(--warning), var(--warning-dark));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    
    .section-body {
        padding: 2rem;
    }
    
    /* Стили для полей ввода */
    .form-control {
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 0.75rem 1rem;
        font-size: 1rem;
        transition: all 0.3s ease;
        background-color: rgba(20, 20, 40, 0.5);
        color: var(--light);
        box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    
    .form-control:focus {
        border-color: var(--warning);
        box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.25);
        background-color: rgba(30, 30, 60, 0.7);
    }
    
    .form-label {
        font-weight: 500;
        margin-bottom: 0.5rem;
        color: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
    }
    
    .form-label i {
        margin-right: 0.5rem;
        color: var(--warning);
    }
    
    /* Улучшенный шаблон для транспорта */
    .transport-item {
        background: rgba(30, 30, 60, 0.5);
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
        position: relative;
        border: 1px solid rgba(255, 255, 255, 0.1);
        margin-bottom: 1.5rem;
        transition: all 0.3s ease;
    }
    
    .transport-item:hover {
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        transform: translateY(-3px);
        border-color: rgba(255, 255, 255, 0.2);
    }
    
    .btn-close {
        background: rgba(239, 68, 68, 0.2);
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--danger-light);
        transition: all 0.3s ease;
        border: none;
        position: absolute;
        top: 1rem;
        right: 1rem;
        opacity: 0.7;
    }
    
    .btn-close:hover {
        background: rgba(239, 68, 68, 0.3);
        opacity: 1;
        transform: rotate(90deg);
    }
    
    /* Стилизованный выбор резервуара/вагона */
    .storage-option {
        display: flex;
        gap: 20px;
        margin-bottom: 1.5rem;
    }
    
    .storage-option-item {
        flex: 1;
        position: relative;
    }
    
    .storage-option-input {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
    }
    
    .storage-option-label {
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        background: rgba(30, 30, 60, 0.5);
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 1.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
    }
    
    .storage-option-label i {
        font-size: 2.5rem;
        margin-bottom: 1rem;
        color: rgba(255, 255, 255, 0.7);
        transition: all 0.3s ease;
    }
    
    .storage-option-label .option-title {
        font-weight: 600;
        margin: 0;
        transition: all 0.3s ease;
        color: rgba(255, 255, 255, 0.9);
    }
    
    .storage-option-input:checked + .storage-option-label {
        border-color: var(--warning);
        background: rgba(245, 158, 11, 0.1);
        box-shadow: 0 5px 15px rgba(245, 158, 11, 0.15);
        transform: translateY(-3px);
    }
    
    .storage-option-input:checked + .storage-option-label i {
        color: var(--warning);
        transform: scale(1.1);
    }
    
    .storage-option-input:checked + .storage-option-label .option-title {
        color: var(--warning);
    }
    
    /* Прогресс бар */
    .progress {
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        height: 15px !important;
        overflow: hidden;
        margin-top: 12px !important;
    }
    
    .progress-bar {
        border-radius: 10px;
        background-image: linear-gradient(45deg, rgba(255,255,255,0.15) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.15) 50%, rgba(255,255,255,0.15) 75%, transparent 75%, transparent);
        background-size: 1rem 1rem;
        animation: progress-bar-stripes 1s linear infinite;
    }
    
    @keyframes progress-bar-stripes {
        from { background-position: 1rem 0; }
        to { background-position: 0 0; }
    }
    
    /* Кнопки */
    .btn-reception {
        background: linear-gradient(to right, var(--warning), var(--warning-dark));
        color: white;
        border: none;
        border-radius: 50px;
        padding: 1rem 2rem;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px rgba(245, 158, 11, 0.3);
        position: relative;
        overflow: hidden;
    }
    
    .btn-reception:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(245, 158, 11, 0.4);
    }
    
    .btn-reception:active {
        transform: translateY(-1px);
    }
    
    .btn-reception::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(to right, rgba(255, 255, 255, 0), rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0));
        transform: translateX(-100%);
        transition: transform 0.5s ease;
    }
    
    .btn-reception:hover::after {
        transform: translateX(100%);
    }
    
    /* Добавим анимацию пульсации для кнопок */
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(245, 158, 11, 0); }
        100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); }
    }
    
    #add-transport {
        animation: pulse 2s infinite;
    }
    
    /* Улучшенные выпадающие списки */
    select.form-control {
        appearance: none;
        -webkit-appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white' width='18px' height='18px'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 1rem center;
        padding-right: 2.5rem;
    }
    
    /* Адаптивность */
    @media (max-width: 992px) {
        .page-header h1 {
            font-size: 2rem;
        }
        
        .section-body {
            padding: 1.5rem;
        }
    }
    
    @media (max-width: 768px) {
        .page-header h1 {
            font-size: 1.8rem;
        }
        
        .section-body {
            padding: 1rem;
        }
        
        .storage-option {
            flex-direction: column;
            gap: 10px;
        }
    }
    
    /* Анимации для форм */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .animate-fade-in-up {
        animation: fadeInUp 0.5s ease forwards;
    }
    
    .delay-1 {
        animation-delay: 0.1s;
    }
    
    .delay-2 {
        animation-delay: 0.3s;
    }
    
    .delay-3 {
        animation-delay: 0.5s;
    }
    
    .delay-4 {
        animation-delay: 0.7s;
    }
    
    /* Улучшенное модальное окно */
    .modal-content {
        background: rgba(30, 30, 60, 0.9);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        color: var(--light);
    }
    
    .modal-header {
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding: 1.5rem;
    }
    
    .modal-title {
        color: var(--light);
        font-weight: 600;
    }
    
    .modal-body {
        padding: 2rem;
    }
    
    .modal-footer {
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        padding: 1.5rem;
    }
    
    /* Стилизованные уведомления */
    .notification {
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        animation: slideIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    /* Фокус на доступности */
    :focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.5);
    }
    
    /* Улучшенные эффекты при наведении */
    .form-control:hover:not(:focus) {
        border-color: rgba(245, 158, 11, 0.3);
    }
</style>
{% endblock %}

{% block content %}
<!-- Стеклянный градиентный фон -->
<div class="glass-bg"></div>

<!-- Декоративные плавающие иконки -->
<div class="floating-icons">
    <i class="fas fa-truck floating-icon" style="top: 10%; left: 5%; font-size: 3rem; color: var(--warning); animation-delay: 0s; animation-duration: 30s;"></i>
    <i class="fas fa-oil-can floating-icon" style="top: 20%; right: 10%; font-size: 2.5rem; color: var(--primary); animation-delay: 5s; animation-duration: 25s;"></i>
    <i class="fas fa-drum floating-icon" style="bottom: 15%; left: 15%; font-size: 3.5rem; color: var(--info); animation-delay: 10s; animation-duration: 40s;"></i>
    <i class="fas fa-gas-pump floating-icon" style="bottom: 25%; right: 5%; font-size: 2.8rem; color: var(--secondary); animation-delay: 15s; animation-duration: 35s;"></i>
    <i class="fas fa-tachometer-alt floating-icon" style="top: 40%; left: 30%; font-size: 2.2rem; color: var(--warning); animation-delay: 7s; animation-duration: 27s;"></i>
</div>

<div class="container-fluid py-4">
    <!-- Заголовок и хлебные крошки -->
    <div class="d-flex flex-column align-items-center">
        <div class="page-header">
            <h1><i class="fas fa-truck-loading me-3"></i>Приемка товара</h1>
        </div>
        
        <div class="breadcrumb-container mb-4">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'sales:dashboard' %}"><i class="fas fa-home me-1"></i>Главная</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Приемка товара</li>
                </ol>
            </nav>
        </div>
    </div>
    
    <!-- Форма приемки -->
    <form method="post" id="receptionForm" class="mb-5">
        {% csrf_token %}
        <input type="hidden" name="quantity" id="movement-quantity" value="0">
        
        <!-- Основная информация -->
        <div class="form-section animate-fade-in-up delay-1">
            <div class="section-header">
                <h3><i class="fas fa-info-circle"></i> Основная информация</h3>
            </div>
            <div class="section-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="id_transaction_type" class="form-label">
                            <i class="fas fa-exchange-alt"></i> Тип транзакции:
                        </label>
                        <input type="text" id="id_transaction_type" class="form-control" value="Приемка" readonly>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="{{ form.document_number.id_for_label }}" class="form-label">
                            <i class="fas fa-file-alt"></i> Номер документа:
                        </label>
                        {{ form.document_number }}
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="{{ form.date.id_for_label }}" class="form-label">
                            <i class="fas fa-calendar-alt"></i> Дата:
                        </label>
                        {{ form.date }}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.product.id_for_label }}" class="form-label">
                            <i class="fas fa-oil-can"></i> Продукт:
                        </label>
                        {{ form.product }}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.client.id_for_label }}" class="form-label">
                            <i class="fas fa-user"></i> Клиент:
                        </label>
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <div class="btn-group client-type-toggle" role="group">
                                    <button type="button" class="btn btn-outline-light client-type-btn active" data-type="local">
                                        <i class="fas fa-home"></i> Местный
                                    </button>
                                    <button type="button" class="btn btn-outline-light client-type-btn" data-type="international">
                                        <i class="fas fa-globe"></i> Международный
                                    </button>
                                </div>
                            </div>
                            {{ form.client }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Информация о транспорте -->
        <div class="form-section animate-fade-in-up delay-2">
            <div class="section-header">
                <h3><i class="fas fa-truck"></i> Информация о транспорте</h3>
            </div>
            <div class="section-body">
                <div class="row mb-4">
                    <div class="col-md-6 mx-auto">
                        <label for="transport_type" class="form-label text-center d-block mb-3">
                            <i class="fas fa-truck-moving"></i> Выберите тип транспорта:
                        </label>
                        <div class="storage-option">
                            <div class="storage-option-item">
                                <input type="radio" id="transport_truck" name="transport_type" value="truck" class="storage-option-input transport-type-radio">
                                <label for="transport_truck" class="storage-option-label">
                                    <i class="fas fa-truck"></i>
                                    <span class="option-title">Автомобильный</span>
                                </label>
                            </div>
                            <div class="storage-option-item">
                                <input type="radio" id="transport_wagon" name="transport_type" value="wagon" class="storage-option-input transport-type-radio">
                                <label for="transport_wagon" class="storage-option-label">
                                    <i class="fas fa-train"></i>
                                    <span class="option-title">Железнодорожный</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="transports-container">
                    <!-- Шаблон для элемента транспорта будет добавлен с помощью JavaScript -->
                    <div class="transport-item d-none" id="transport-template">
                        <button type="button" class="btn-close remove-transport">
                            <i class="fas fa-times"></i>
                        </button>
                        
                        <!-- Общие поля для всех типов транспорта -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">
                                    <i class="fas fa-hashtag"></i> Номер транспорта:
                                </label>
                                <input type="text" name="transport_number[]" class="form-control" required>
                            </div>
                        </div>
                        
                        <!-- Поля для автомобильного транспорта -->
                        <div class="truck-fields">
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label class="form-label">
                                        <i class="fas fa-weight"></i> Плотность:
                                    </label>
                                    <input type="number" name="density[]" class="form-control density-input" step="0.01">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">
                                        <i class="fas fa-temperature-high"></i> Температура:
                                    </label>
                                    <input type="number" name="temperature[]" class="form-control temperature-input" value="20">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">
                                        <i class="fas fa-fill-drip"></i> Объем (литры):
                                    </label>
                                    <input type="number" name="liter[]" class="form-control liter-input" step="0.01">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Поля для железнодорожного транспорта -->
                        <div class="wagon-fields" style="display:none;">
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label class="form-label">
                                        <i class="fas fa-train"></i> Тип вагона:
                                    </label>
                                    <select name="wagon_type[]" class="form-control">
                                        <option value="">Выберите тип</option>
                                        {% for wagon_type in wagon_types %}
                                        <option value="{{ wagon_type.id }}">{{ wagon_type.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">
                                        <i class="fas fa-weight-hanging"></i> Грузоподъемность (тонн):
                                    </label>
                                    <input type="number" name="capacity[]" class="form-control capacity-input" step="0.01">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">
                                        <i class="fas fa-balance-scale"></i> Тара вагона (кг):
                                    </label>
                                    <input type="number" name="tare_weight[]" class="form-control tare-weight-input" step="1">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Общие поля веса -->
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label class="form-label">
                                    <i class="fas fa-file-invoice"></i> Документальный вес (кг):
                                </label>
                                <input type="number" name="doc_ton[]" class="form-control doc-ton-input" step="0.01" required>
                                <small class="text-light opacity-75">Из накладной отдела продаж</small>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">
                                    <i class="fas fa-weight"></i> Фактический вес (кг):
                                </label>
                                <input type="number" name="quantity[]" class="form-control quantity-input" step="0.01" required value="0">
                                <small class="text-light opacity-75">Вводится эстокадой после взвешивания</small>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">
                                    <i class="fas fa-not-equal"></i> Разница (кг):
                                </label>
                                <div class="input-group">
                                    <input type="number" name="difference[]" class="form-control difference-input" readonly>
                                    <div class="input-group-text difference-indicator">
                                        <i class="fas"></i>
                                    </div>
                                </div>
                                <small class="text-light opacity-75 difference-text"></small>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">
                                    <i class="fas fa-percentage"></i> Отклонение (%):
                                </label>
                                <input type="number" name="deviation_percent[]" class="form-control deviation-percent-input" readonly>
                                <small class="text-light opacity-75">Допустимо: ±0.5%</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="d-flex justify-content-center mt-4">
                    <button type="button" id="add-transport" class="btn btn-reception">
                        <i class="fas fa-plus-circle me-2"></i> Добавить транспорт
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Куда положить товар -->
        <div class="form-section animate-fade-in-up delay-3">
            <div class="section-header">
                <h3><i class="fas fa-warehouse"></i> Куда положить товар</h3>
            </div>
            <div class="section-body">
                <div class="row mb-4">
                    <div class="col-md-6 mx-auto">
                        <div class="storage-option">
                            <div class="storage-option-item">
                                <input type="radio" id="storage_reservoir" name="placement" value="reservoir" class="storage-option-input placement-radio" checked>
                                <label for="storage_reservoir" class="storage-option-label">
                                    <i class="fas fa-water"></i>
                                    <span class="option-title">Резервуар</span>
                                </label>
                            </div>
                            <div class="storage-option-item">
                                <input type="radio" id="storage_wagon" name="placement" value="wagon" class="storage-option-input placement-radio">
                                <label for="storage_wagon" class="storage-option-label">
                                    <i class="fas fa-train"></i>
                                    <span class="option-title">Вагон</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="reservoir-fields">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="id_reservoir" class="form-label">
                                <i class="fas fa-database"></i> Выберите резервуар:
                            </label>
                            <select name="reservoir" id="id_reservoir" class="form-control">
                                <option value="">Выберите резервуар</option>
                                {% for reservoir in reservoirs %}
                                <option value="{{ reservoir.id }}" data-capacity="{{ reservoir.capacity }}" data-empty-space="{{ reservoir.empty_space }}">
                                    {{ reservoir.name }} ({{ reservoir.product.name }}, свободно: {{ reservoir.empty_space|floatformat:2 }} кг)
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">
                                <i class="fas fa-tachometer-alt"></i> Текущее заполнение:
                            </label>
                            <div class="progress" style="height: 25px; margin-top: 8px;">
                                <div id="reservoir-fill-level" class="progress-bar bg-warning" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="wagon-fields" style="display: none;">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="id_wagon" class="form-label">
                                <i class="fas fa-train"></i> Выберите вагон:
                            </label>
                            <select name="wagon" id="id_wagon" class="form-control">
                                <option value="">Выберите вагон</option>
                                {% for wagon in wagons %}
                                <option value="{{ wagon.id }}" data-capacity="{{ wagon.capacity }}" data-empty-space="{{ wagon.empty_space }}">
                                    {{ wagon.number }} ({{ wagon.product.name }}, свободно: {{ wagon.empty_space|floatformat:2 }} кг)
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">
                                <i class="fas fa-tachometer-alt"></i> Текущее заполнение:
                            </label>
                            <div class="progress" style="height: 25px; margin-top: 8px;">
                                <div id="wagon-fill-level" class="progress-bar bg-info" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Кнопки управления -->
        <div class="d-flex justify-content-center my-5 animate-fade-in-up delay-4">
            <button type="submit" class="btn btn-reception">
                <i class="fas fa-save me-2"></i> Сохранить приемку
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script>
    $(document).ready(function() {
        console.log("Форма приемки инициализирована");
        
        // Инициализация Select2 для улучшенных выпадающих списков
        $('select').select2({
            theme: 'classic',
            placeholder: 'Выберите...',
            allowClear: true,
            width: '100%'
        });
        
        // Устанавливаем текущую дату в поле даты, если оно пустое
        if (!$('#{{ form.date.id_for_label }}').val()) {
            const today = new Date();
            const formattedDate = today.toISOString().substring(0, 10);
            $('#{{ form.date.id_for_label }}').val(formattedDate);
        }
        
        // Автогенерация номера документа при загрузке страницы, если поле пустое
        if (!$('#{{ form.document_number.id_for_label }}').val()) {
            const prefix = 'REC';
            const timestamp = Date.now().toString();
            const randomNum = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            const documentNumber = `${prefix}${timestamp.substring(timestamp.length - 6)}${randomNum}`;
            
            $('#{{ form.document_number.id_for_label }}').val(documentNumber);
        }
        
        // Обработка выбора типа транспорта
        $('.transport-type-radio').on('change', function() {
            const transportType = $(this).val();
            console.log(`Выбран тип транспорта: ${transportType}`);
            
            // Очищаем контейнер с транспортом
            $('#transports-container').children().not('#transport-template').remove();
            
            // Активируем кнопку добавления транспорта
            $('#add-transport').prop('disabled', false);
        });
        
        // Обработка выбора места размещения
        $('.placement-radio').on('change', function() {
            const placement = $(this).val();
            console.log(`Выбрано размещение: ${placement}`);
            
            if (placement === 'reservoir') {
                $('#reservoir-fields').show();
                $('#wagon-fields').hide();
            } else {
                $('#reservoir-fields').hide();
                $('#wagon-fields').show();
            }
        });
        
        // Функция для добавления нового транспорта
        $('#add-transport').on('click', function() {
            const transportType = $('input[name="transport_type"]:checked').val();
            
            if (!transportType) {
                showNotification('Пожалуйста, выберите тип транспорта', 'warning');
                return;
            }
            
            // Клонируем шаблон транспорта
            const newTransport = $('#transport-template').clone();
            newTransport.removeClass('d-none').removeAttr('id');
            newTransport.addClass('animate-fade-in-up');
            
            // Настраиваем поля в зависимости от типа транспорта
            if (transportType === 'truck') {
                newTransport.find('.truck-fields').show();
                newTransport.find('.wagon-fields').hide();
            } else {
                newTransport.find('.truck-fields').hide();
                newTransport.find('.wagon-fields').show();
            }
            
            // Добавляем транспорт в контейнер
            $('#transports-container').append(newTransport);
            
            // Обновляем общее количество при изменении количества
            newTransport.find('.quantity-input').on('input', updateTotalQuantity);
            
            // Автоматически рассчитываем разницу между документальным и фактическим весом
            newTransport.find('.quantity-input, .doc-ton-input').on('input', function() {
                const transportItem = $(this).closest('.transport-item');
                const docQuantity = parseFloat(transportItem.find('.doc-ton-input').val()) || 0;
                const actualQuantity = parseFloat(transportItem.find('.quantity-input').val()) || 0;
                
                // Разница (фактический минус документальный)
                const difference = actualQuantity - docQuantity;
                transportItem.find('.difference-input').val(difference.toFixed(2));
                
                // Расчет процента отклонения
                let deviationPercent = 0;
                if (docQuantity > 0) {
                    deviationPercent = (difference / docQuantity) * 100;
                }
                transportItem.find('.deviation-percent-input').val(deviationPercent.toFixed(2));
                
                // Выделяем разницу цветом и индикатором в зависимости от значения
                const differenceInput = transportItem.find('.difference-input');
                const differenceIndicator = transportItem.find('.difference-indicator');
                const differenceText = transportItem.find('.difference-text');
                
                if (difference < 0) {
                    differenceInput.css('color', 'var(--danger-light)');
                    differenceIndicator.removeClass('bg-success').addClass('bg-danger');
                    differenceIndicator.find('i').removeClass('fa-plus-circle').addClass('fa-minus-circle');
                    differenceText.text('Недостача. Требуется проверка!');
                    differenceText.css('color', 'var(--danger-light)');
                } else if (difference > 0) {
                    differenceInput.css('color', 'var(--success-light)');
                    differenceIndicator.removeClass('bg-danger').addClass('bg-success');
                    differenceIndicator.find('i').removeClass('fa-minus-circle').addClass('fa-plus-circle');
                    differenceText.text('Излишек. Проверить калибровку!');
                    differenceText.css('color', 'var(--success-light)');
                } else {
                    differenceInput.css('color', 'var(--light)');
                    differenceIndicator.removeClass('bg-danger bg-success').addClass('bg-secondary');
                    differenceIndicator.find('i').removeClass('fa-minus-circle fa-plus-circle').addClass('fa-equals');
                    differenceText.text('Нет расхождений');
                    differenceText.css('color', 'var(--light)');
                }
                
                // Выделяем отклонение в процентах
                const deviationInput = transportItem.find('.deviation-percent-input');
                if (Math.abs(deviationPercent) > 0.5) {
                    deviationInput.css('color', 'var(--danger-light)');
                } else {
                    deviationInput.css('color', 'var(--success-light)');
                }
            });
            
            // Для автоцистерн автоматически рассчитываем количество в кг из объема и плотности
            newTransport.find('.density-input, .liter-input').on('input', function() {
                const transportItem = $(this).closest('.transport-item');
                const density = parseFloat(transportItem.find('.density-input').val()) || 0;
                const volume = parseFloat(transportItem.find('.liter-input').val()) || 0;
                
                if (density > 0 && volume > 0) {
                    const quantityKg = density * volume;
                    transportItem.find('.quantity-input').val(quantityKg.toFixed(2)).trigger('input');
                }
            });
            
            // Обработка удаления транспорта
            newTransport.find('.remove-transport').on('click', function() {
                $(this).closest('.transport-item').fadeOut(300, function() {
                    $(this).remove();
                    updateTotalQuantity();
                });
            });
            
            // Добавляем анимацию прокрутки к новому транспорту
            $('html, body').animate({
                scrollTop: newTransport.offset().top - 100
            }, 500);
            
            console.log(`Добавлен новый транспорт типа: ${transportType}`);
        });
        
        // Обновление общего количества товара
        function updateTotalQuantity() {
            let totalQuantity = 0;
            $('.quantity-input').each(function() {
                if (!$(this).closest('#transport-template').length) {
                    totalQuantity += parseFloat($(this).val()) || 0;
                }
            });
            
            $('#movement-quantity').val(totalQuantity.toFixed(2));
            console.log(`Общее количество обновлено: ${totalQuantity.toFixed(2)} кг`);
            
            // Обновляем индикатор заполнения резервуара/вагона
            updateStorageFillLevel();
        }
        
        // Обновление индикатора заполнения хранилища
        function updateStorageFillLevel() {
            const totalQuantity = parseFloat($('#movement-quantity').val()) || 0;
            
            if ($('#storage_reservoir').is(':checked')) {
                const selectedReservoir = $('#id_reservoir option:selected');
                const capacity = parseFloat(selectedReservoir.data('capacity')) || 0;
                const emptySpace = parseFloat(selectedReservoir.data('empty-space')) || 0;
                
                if (capacity > 0) {
                    const currentFill = capacity - emptySpace;
                    const currentPercentage = (currentFill / capacity) * 100;
                    const newFill = currentFill + totalQuantity;
                    const newPercentage = (newFill / capacity) * 100;
                    
                    // Обновляем индикатор
                    $('#reservoir-fill-level').css('width', `${currentPercentage}%`).attr('aria-valuenow', currentPercentage);
                    $('#reservoir-fill-level').text(`${currentPercentage.toFixed(1)}%`);
                    
                    // Показываем предупреждение, если новое заполнение превышает емкость
                    if (newFill > capacity) {
                        showNotification('Внимание! Количество товара превышает емкость резервуара!', 'danger');
                        $('#reservoir-fill-level').addClass('bg-danger').removeClass('bg-warning');
                    } else {
                        $('#reservoir-fill-level').addClass('bg-warning').removeClass('bg-danger');
                    }
                }
            } else {
                const selectedWagon = $('#id_wagon option:selected');
                const capacity = parseFloat(selectedWagon.data('capacity')) || 0;
                const emptySpace = parseFloat(selectedWagon.data('empty-space')) || 0;
                
                if (capacity > 0) {
                    const currentFill = capacity - emptySpace;
                    const currentPercentage = (currentFill / capacity) * 100;
                    const newFill = currentFill + totalQuantity;
                    const newPercentage = (newFill / capacity) * 100;
                    
                    // Обновляем индикатор
                    $('#wagon-fill-level').css('width', `${currentPercentage}%`).attr('aria-valuenow', currentPercentage);
                    $('#wagon-fill-level').text(`${currentPercentage.toFixed(1)}%`);
                    
                    // Показываем предупреждение, если новое заполнение превышает емкость
                    if (newFill > capacity) {
                        showNotification('Внимание! Количество товара превышает емкость вагона!', 'danger');
                        $('#wagon-fill-level').addClass('bg-danger').removeClass('bg-info');
                    } else {
                        $('#wagon-fill-level').addClass('bg-info').removeClass('bg-danger');
                    }
                }
            }
        }
        
        // Обработка выбора резервуара или вагона
        $('#id_reservoir, #id_wagon').on('change', updateStorageFillLevel);
        
        // Валидация формы перед отправкой
        $('#receptionForm').on('submit', function(e) {
            const transportItems = $('#transports-container').children().not('#transport-template');
            
            if (transportItems.length === 0) {
                e.preventDefault();
                showNotification('Пожалуйста, добавьте хотя бы один транспорт', 'warning');
                return false;
            }
            
            const totalQuantity = parseFloat($('#movement-quantity').val());
            if (isNaN(totalQuantity) || totalQuantity <= 0) {
                e.preventDefault();
                showNotification('Общее количество должно быть больше нуля', 'warning');
                return false;
            }
            
            // Проверяем выбор резервуара/вагона
            if ($('#storage_reservoir').is(':checked')) {
                if (!$('#id_reservoir').val()) {
                    e.preventDefault();
                    showNotification('Пожалуйста, выберите резервуар', 'warning');
                    return false;
                }
                
                const selectedReservoir = $('#id_reservoir option:selected');
                const emptySpace = parseFloat(selectedReservoir.data('empty-space')) || 0;
                
                if (totalQuantity > emptySpace) {
                    const confirmOverfill = confirm(`Внимание! Количество товара (${totalQuantity.toFixed(2)} кг) превышает свободное место в резервуаре (${emptySpace.toFixed(2)} кг). Продолжить?`);
                    if (!confirmOverfill) {
                        e.preventDefault();
                        return false;
                    }
                }
            } else {
                if (!$('#id_wagon').val()) {
                    e.preventDefault();
                    showNotification('Пожалуйста, выберите вагон', 'warning');
                    return false;
                }
                
                const selectedWagon = $('#id_wagon option:selected');
                const emptySpace = parseFloat(selectedWagon.data('empty-space')) || 0;
                
                if (totalQuantity > emptySpace) {
                    const confirmOverfill = confirm(`Внимание! Количество товара (${totalQuantity.toFixed(2)} кг) превышает свободное место в вагоне (${emptySpace.toFixed(2)} кг). Продолжить?`);
                    if (!confirmOverfill) {
                        e.preventDefault();
                        return false;
                    }
                }
            }
            
            return true;
        });
        
        // Функция для показа уведомлений
        function showNotification(message, type = 'info') {
            // Создаем элемент уведомления
            const notification = $(`
                <div class="notification notification-${type}">
                    <div class="notification-icon">
                        <i class="fas fa-${type === 'info' ? 'info-circle' : type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'times-circle'}"></i>
                    </div>
                    <div class="notification-content">${message}</div>
                    <button class="notification-close"><i class="fas fa-times"></i></button>
                </div>
            `).css({
                'position': 'fixed',
                'top': '20px',
                'right': '20px',
                'z-index': '9999',
                'display': 'flex',
                'align-items': 'center',
                'background': type === 'info' ? 'rgba(6, 182, 212, 0.95)' : 
                              type === 'success' ? 'rgba(16, 185, 129, 0.95)' : 
                              type === 'warning' ? 'rgba(245, 158, 11, 0.95)' : 
                              'rgba(239, 68, 68, 0.95)',
                'color': 'white',
                'padding': '15px 20px',
                'border-radius': '10px',
                'box-shadow': '0 5px 15px rgba(0, 0, 0, 0.2)',
                'max-width': '350px',
                'transform': 'translateX(400px)',
                'opacity': '0',
                'transition': 'all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55)'
            });
            
            // Стили для иконки
            notification.find('.notification-icon').css({
                'margin-right': '15px',
                'font-size': '1.5rem'
            });
            
            // Стили для контента
            notification.find('.notification-content').css({
                'flex': '1'
            });
            
            // Стили для кнопки закрытия
            notification.find('.notification-close').css({
                'background': 'none',
                'border': 'none',
                'color': 'white',
                'font-size': '1rem',
                'cursor': 'pointer',
                'margin-left': '10px',
                'opacity': '0.7',
                'transition': 'opacity 0.3s ease'
            }).hover(
                function() { $(this).css('opacity', '1'); },
                function() { $(this).css('opacity', '0.7'); }
            );
            
            // Добавляем уведомление в DOM
            $('body').append(notification);
            
            // Анимируем появление
            setTimeout(() => {
                notification.css({
                    'transform': 'translateX(0)',
                    'opacity': '1'
                });
            }, 10);
            
            // Настраиваем автоматическое скрытие
            const timeout = setTimeout(() => {
                hideNotification(notification);
            }, 5000);
            
            // Обработка закрытия по клику
            notification.find('.notification-close').on('click', function() {
                clearTimeout(timeout);
                hideNotification(notification);
            });
            
            // Функция скрытия уведомления
            function hideNotification(element) {
                element.css({
                    'transform': 'translateX(400px)',
                    'opacity': '0'
                });
                
                setTimeout(() => {
                    element.remove();
                }, 500);
            }
        }
        
        // Добавление базовых стилей для уведомлений
        $('<style>')
            .text(`
                @keyframes notification-pulse {
                    0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4); }
                    70% { box-shadow: 0 0 0 10px rgba(255, 255, 255, 0); }
                    100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
                }
                
                .notification-icon {
                    animation: notification-pulse 2s infinite;
                }
            `)
            .appendTo('head');

        // Функции для работы с клиентами
        $('.client-type-btn').on('click', function() {
            const type = $(this).data('type');
            $('.client-type-btn').removeClass('active');
            $(this).addClass('active');
            
            // Фильтруем список клиентов
            const clientSelect = $('#{{ form.client.id_for_label }}');
            
            // Сохраняем текущее значение
            const currentValue = clientSelect.val();
            
            // Временно отключаем select2 для быстрого обновления
            if ($.fn.select2) {
                clientSelect.select2('destroy');
            }
            
            // Фильтруем опции
            clientSelect.find('option').each(function() {
                const option = $(this);
                const clientData = option.data() || {};
                
                if (!clientData.type) {
                    // Если тип не указан, показываем всегда (например, пустое значение)
                    option.show();
                } else if (clientData.type === type) {
                    option.show();
                } else {
                    option.hide();
                }
            });
            
            // Восстанавливаем select2
            if ($.fn.select2) {
                clientSelect.select2({
                    theme: 'classic',
                    placeholder: 'Выберите клиента',
                    allowClear: true,
                    width: '100%'
                });
            }
            
            // Пытаемся восстановить значение, если оно было
            if (currentValue) {
                clientSelect.val(currentValue);
                if ($.fn.select2) {
                    clientSelect.trigger('change.select2');
                }
            }
        });
    });
</script>
{% endblock %} 